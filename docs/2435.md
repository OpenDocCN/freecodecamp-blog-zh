# 谷歌如何进行代码审查——来自谷歌文档的质量保证提示

> 原文：<https://www.freecodecamp.org/news/what-google-taught-me-about-code-reviews/>

代码审查，有时也称为代码质量保证，是在您编写代码后让其他人检查您的代码的实践。

代码评审给编写和交付软件的过程带来了许多好处:

*   确保代码库的一致性。
*   教导所有评审成员(帮助知识转移)。
*   就可能影响团队其他部分的因素建立上下文意识
*   有助于避免破坏构件
*   用新的眼光审视代码变更，寻找变更中的优化和简化。
*   提高质量，帮助确保没有人忘记或遗漏任何东西。

谷歌在 GitHub 上有 1918 个跨多种语言的知识库，非开源的甚至更多。

他们的一个代码库由超过 25，000 名谷歌员工共享，通常每天有 [40，000 次提交](https://cacm.acm.org/magazines/2016/7/204032-why-google-stores-billions-of-lines-of-code-in-a-single-repository/fulltext)(16，000 次人工修改，24，000 次自动系统修改)。每天，在高峰时段，它必须每秒处理大约 800，000 个查询。

Google 已经发布了他们的工程实践，所以让我们看看他们是如何在他们的规模上审查代码的，一天有这么多提交。

谷歌称他们代码库的变化为 **CLs** 代表变化列表。它只是一个正在接受评审的工作单元/一段代码。

# 如何准备代码评审

首先，在你考虑代码审查过程之前，试着把注意力放在谁将进行审查上。试着挑选一个主题专家。挑选熟悉这个代码库或代码库领域的人。

有时这甚至意味着让不同的人审查代码的不同部分。但是不到 25%的谷歌代码审查有不止一个审查者。

让某人及时回复也很重要。为了避免瓶颈和个人负担过重，只要抄送给审阅者，他们就可以在方便的时候审阅变更。

# 如何运行快速代码评审

代码审查应该快速完成。审查的**最长**时间应为一个工作日。

为什么这么急？我个人的问答有时需要几周甚至更长时间。

*   它变成了一个阻断器。虽然代码的作者开始了新的工作，但是新的变更开始形成积压的工作，延迟可能会达到几周或几个月。
*   **开发者感到沮丧。**如果评审员要求进行重大变更，但每 3 天才回复一次，这对于致力于该变更的开发人员来说是令人沮丧的。但是有了快速反应，无论何时你需要解释你到底需要做什么，挫败感就会消失。
*   代码质量会降低。如果你的评审总是很慢，开发人员就不太可能进行代码清理、重构工作或一般性的代码改进(“如果我的评审员 4 天不回复，那还有什么意义？”)，并且在评审中提交的代码质量更有可能下降。

代码评审之所以快速的主要原因是因为它们很小。它们不是发送一个 1000 行的 CL，而是被分成多个 CL——例如，推送 10 个 100 行的较小变化。

谷歌也有紧急情况，需要快速修改代码来解决生产中的主要问题。在这些情况下，代码质量是宽松的。这项审查应该立即成为审查者的首要任务。如果你好奇的话，这里有一些谷歌面临的紧急情况的例子。

## 谷歌的代码审查标准

谷歌强调的关键规则是:

一旦某项更改确实改善了代码的整体健康状况，即使它并不完美，评审人员通常也应该批准它。

谷歌似乎想说的关键点是完美的代码是不存在的。如果它使**变得更好**，那就足够了。

这无疑是一种平衡行为，既要让事情变得更好，又要让事情变得更好。如果您可以添加更多的反馈来进行重大改进，可能需要对代码做更多的工作。

## 谷歌员工在代码评审中寻找什么

当进行代码评审时，Google 根据他们的[工程实践文档](https://google.github.io/eng-practices/review/reviewer/looking-for.html)关注这些元素:

> **设计**:代码是否设计良好，是否适合你的系统？这种改变属于你的代码库，还是属于一个库？它与您系统的其余部分集成得好吗？
> 
> **功能**:代码的行为是否如作者所愿？代码的行为方式对用户有益吗？大多数情况下，我们希望开发人员能够很好地测试 CLs 足够让他们在进行代码评审时能够正确工作。
> 
> **复杂度**:代码能不能简单点？当另一个开发人员将来遇到这些代码时，他们能够容易地理解和使用这些代码吗？对于当前的使用情形，它是否过度设计了？
> 
> **测试**:代码是否有正确的、设计良好的自动化测试？当代码被破坏时，测试真的会失败吗？他们会开始产生假阳性吗？每个测试都做出简单有用的断言吗？
> 
> **命名**:开发者是否为变量、类、方法等选择了明确的名称。？
> 
> **评论**:评论是否清晰有用？确保明智的评论解释为什么做某事，而不是如何做。
> 
> **风格&一致性**:代码是否遵循我们的[风格指南](http://google.github.io/styleguide/)？
> 
> **文档**:开发者是否也更新了相关文档？

谷歌有多种语言的风格指南，如 [C++](https://google.github.io/styleguide/cppguide.html) 、 [Swift](https://google.github.io/swift/) 、 [HTML/CSS](https://google.github.io/styleguide/htmlcssguide.html) 、 [Lisp](https://google.github.io/styleguide/lispguide.xml) 、 [JavaScript](https://google.github.io/styleguide/jsguide.html) 和[等等。](https://google.github.io/styleguide/)

拥有一个每个人都可以参考的文档有助于规范代码。这也有助于澄清评审过程中的期望。

## 谷歌员工如何审查代码

在谷歌的工程实践中，代码审查有一个三阶段的过程。如果你要复习的话，以下是你需要涵盖的内容列表:

1.  获得变更的高级概述
2.  检查变化的主要部分
3.  按照合理的顺序浏览代码的其余部分

让我们更详细地检查一下每个步骤。

## 1.获得代码更改的高级概述

查看代码变更的描述/摘要。这一切有意义吗？例如，如果有人修改了下周要删除的代码库，礼貌地将修改推回*，*并解释为什么不再需要修改。

如果人们把时间花在实际上并不需要的工作上，这是低效的，所以看看你的开发生命周期，看看为什么会发生这种情况。你越早发现这些问题越好。

为了获得代码的高层次概述，您可能希望简单地浏览一下代码组件，看看它们是如何一起工作的。

如果你看到一个严重的架构问题或者一些重大的错误，你应该在这个阶段立即分享你的观察。即使你没有时间去回顾评论的每一个元素。如果架构问题足够严重的话，审查其余部分甚至可能是浪费时间。

除此之外，您应该立即发送评估意见还有两个主要原因:

*   谷歌员工通常会通过电子邮件发送变更，然后立即根据该变更开始新的工作。如果评审中的变更需要认真的调整，那么他们可能是建立在一些需要显著改变的东西上。
*   对 CL 的重大修改可能需要一段时间才能完成。开发人员都有截止日期，礼貌的做法是让他们尽快开始返工，从而帮助他们满足截止日期。

## 2.检查代码更改的主要部分

一旦你有了一个概览，回顾一下变化的“主要”部分。

查找对 CL 至关重要的一个或多个文件。通常，有一个文件有最多的变化，它是 CL 的主要部分。

花你大部分的注意力来回顾这些作品。这为所有较小的部分提供了上下文，通常会使审查更快。

如果 CL 对于你来说太大了，以至于不能得到一个好的概览和理解流程，这是一个好的迹象，开发者应该把他们的 CL 分成更小的变更。

## 3.按照合理的顺序浏览代码的其余部分

一旦您对更改有了一个很好的概述，就该深入到细节并逐个文件地进行了。

每个评审者通常做不同的事情。有些按照版本控制显示的顺序进行，有些选择特定的顺序。选择对你有意义的。重要的是复习所有的东西，不要错过任何东西。

### 审查每一行代码

不要错过或忽略重要的细节。有时可能会有配置文件或生成的代码，您可以简单地浏览一下，寻找不规则之处。但你在这里的工作是非常彻底和仔细地审查代码。

确保您考虑了错误、竞争条件、替代方法、简洁性、可读性等等。

如果你不能理解代码，很有可能其他开发人员也不能理解，你应该要求开发人员澄清它。

### 理解上下文

版本控制软件通常只会显示变更的行。但是重要的是要阅读前后的行，或者整个文件，以确保您确切地理解变化在做什么。

您可能只会看到有人在一个变更中添加了 2 个以上的`if`块。但是如果你看看上下文，你可能会看到`if` `else`块现在有 15 个不同的`if`在里面。那么你就可以拒绝代码变更，适当提高这方面的代码质量，而不是让它变得更差。

记住，代码退化是缓慢发生的，伴随着每一个变化。我们的主要目标是确保质量趋势持续上升，我们永远不会倒退。

## **谷歌员工如何编写代码反馈**

谷歌有一些具体的章节，涵盖了如何礼貌而尊重地进行[代码审查](https://chromium.googlesource.com/chromium/src/+/master/docs/cr_respect.md)。这与尽可能清晰和有助于开发人员并不矛盾。这里的黄金法则是对*代码*而不是开发者发表评论。

## 做什么:

#### 

> 询问为什么:如果不清楚作者为什么以某种方式做事，请随意询问他们为什么做了特殊的改变。不知道是可以的，问“为什么”会留下书面记录，有助于将来回答这个问题。(而且有时候，“我很好奇，你为什么决定这么做？”可以帮助作者重新思考他们的决定。)
> 
> **找到终点:**如果你喜欢事情整洁，那么一遍又一遍地检查代码直到它完美，会比必要的时间拖得更长。不过，对于接受者来说，这是一种精神上的麻木。请记住，“LGTM”并不意味着“我保证我不朽的灵魂永远不会失败”，而是“在我看来不错”。如果它看起来不错，继续前进。(这并不意味着你不应该彻底。这是一个判断电话。)如果有更大的重构要做，把它们移到一个新的 CL 中。([来源](https://chromium.googlesource.com/chromium/src/+/HEAD/docs/cr_respect.md))

## 不要做什么

> **不要使用极端或非常负面的语言:**请不要说“没有一个理智的人会这样做”或“这个算法太可怕了”之类的话，无论是关于你正在审阅的更改还是关于周围的代码。虽然这可能会胁迫被评估者做你想做的事情，但从长远来看，这是没有帮助的——他们会觉得自己无能为力，而且里面没有多少信息可以帮助他们改进。“这是一个好的开始，但它可能需要一些工作”或“这需要一些清理”是更好的说法。讨论代码，而不是人。
> 
> **不要骑车出行:**时刻问问自己，这个决定 **从长远来看是否真的重要** 还是你在强制推行一种主观偏好。正确的感觉很好，但两个参与者中只有一个能赢得那场比赛。如果不重要，同意不同意见，继续前进。([来源](https://chromium.googlesource.com/chromium/src/+/HEAD/docs/cr_respect.md))

记住，代码评审有时倾向于发现问题或讨论代码，而不是表扬。

如果你的评论者处理了你的评论，或者他们做了一些你喜欢的优化或智能代码，感谢他们。说你喜欢他们解决问题的方法/方式。

相反，如果评审者彻底解释了他们想要什么，并及时回答了你的问题，你要感谢他们。

我有过一些评论，评论者发表了巨大的评论，解释我误解的东西，我仍然记得是谁和他们说了什么。

## 如何处理代码评审中的推后

有时接受评审的开发人员可能不同意您提出的变更。这是如何处理的。

### 考虑到他们可能是对的

有时候开发人员更接近代码和它是如何工作的，他们可能是对的。如果是，就从那个讨论点开始，让代码保持原样。

但是如果他们不是，或者他们误解了什么，你应该坚持改变。回应开发者最初质疑你的地方，礼貌地解释你的理由。

代码质量的提高往往发生在小的增量步骤中，评审是其中的一种方式。坚持改进代码，即使这意味着开发人员要做额外的工作。

### 尽量避免“我稍后再解决这个问题……”

评审中最常见的问题之一不是人们不同意代码更改是否必要，而是他们想在不同的标签下做或以后做。因此，如果您通过了这一审查，他们向您保证，他们将在以后跟进并解决问题。

一般来说，*后面跟进*的情况很少发生。这并不意味着开发人员或他们的职业道德有问题。但是很容易忘记，改变优先事项，甚至迷失在他们的工作队列中。

坚持现在就完成工作。在您必须立即修复的代码库中合并更改并没有真正的好处。你只是增加了技术债务，这些债务*可能*随后会跟进，或者可能会被遗忘*。*以后处理大量的票很容易导致质量下降。

唯一的例外是[紧急事件](https://google.github.io/eng-practices/review/emergencies.html)，这涉及到谷歌在出现严重错误时处理的最高优先级的错误。这可能是服务中断，或者是生产中的错误导致页面崩溃。

人们自然渴望尽快合并变更，审查可能会接受稍低的质量，并立即编写后续的修复。主要是第一个改动去掉了紧急情况，第二个改动把*固定好了。*

# **结论**

我希望这已经解释了 Google 在他们的代码审查过程中使用的一些有用的概念。我写这篇文章是为了更好地巩固它，并对其他公司如何处理 QA 过程感到好奇。

我发现有相当多的观点我可以带走并应用到我所做的评估中。

我在整篇文章中引用的文档可以在这里找到。

如果你喜欢这篇文章并想看更多，我在 Twitter 上分享我的文章。