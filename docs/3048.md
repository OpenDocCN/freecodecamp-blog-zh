# 电子邮件是如何工作的？

> 原文：<https://www.freecodecamp.org/news/how-does-email-work/>

首先，你使用邮件用户代理或 MUA 从你的设备(如 gmail 或苹果设备上的邮件应用程序)阅读和发送电子邮件。这些程序只有在您使用时才是活动的。

通常，它们与邮件传输代理或 MTA(也称为邮件服务器、MX 主机和邮件交换器)通信，后者用于接收和存储您的电子邮件。

在您打开 MUA 查看电子邮件之前，电子邮件会被远程存储。电子邮件由邮件投递代理(MDA)投递，通常与 MTA 打包在一起。

邮件过去是使用 SMTP 或简单邮件传输协议发送到邮件服务器的。SMTP 是电子邮件的通信协议。

即使是现在，尽管微软 Exchange 等许多专有系统和 Gmail 等网络邮件程序在内部使用自己的协议，但它们使用 SMTP 将邮件传输到系统外部(例如，如果 Gmail 用户想要向 Outlook 客户端发送电子邮件)。

然后，将使用邮局协议(POP3)从服务器下载邮件。POP3 是应用层协议，它为用户应用程序提供经由互联网协议(IP)网络的访问，以联系邮件服务器上的邮箱。它可以连接、检索消息、将消息存储在客户端的计算机上，以及在服务器上删除或保留消息。

它的设计是为了能够管理临时的互联网连接，比如拨号(所以它只会在连接时连接和检索电子邮件，并允许你在离线时查看邮件)。当拨号上网更加普及的时候，这种方式更加流行。

现在，IMAP，互联网信息访问协议，已经大部分取代了 POP3。IMAP 可以允许多个客户端管理同一个邮箱(这样你就可以从你的台式机、笔记本电脑和电话等设备上阅读你的电子邮件。并且您的所有消息都将在那里，以相同的方式组织)。

最终，网络邮件取代了两者。网络邮件允许你登录到一个网站，从任何地方或任何设备接收信息(耶！)，但是您需要连接到互联网才能使用它。如果该网站(如 gmail)是您的 MUA，您不需要知道 SMTP 或 IMAP 服务器设置。

## 如何保护电子邮件的安全？

不幸的是，安全性并没有从一开始就真正内置到邮件协议中(就像大多数互联网协议一样)。服务器只是希望从任何人那里获取任何消息，并将其传递给任何其他服务器，这些服务器可以帮助将消息路由到其最终目的地(to:字段中的收件人)。

毫不奇怪，当互联网从少数政府和研究团体扩展到世界上大多数人用来做几乎所有事情的东西时，这就成了一个问题。很快，垃圾邮件和网络钓鱼邮件就成了每个人的一个大问题。

作为回应，我们集体尝试实施了几项措施，防止人们阅读他人的消息(加密)，并验证消息确实来自声称的发件人(身份验证)。

大多数地方使用 TLS(传输层安全性，SSL 的替代品，安全套接字层)，这是一种在传输中提供加密的加密协议。它为正在传输的消息提供保护，但不保护处于静止状态的数据(例如，存储在您的计算机上)。

这确保了消息在从 MTA 传输到 MTA 的过程中不会被篡改或窃听。然而，这并不能验证消息在旅行中没有被修改。

例如，如果电子邮件在到达最终目的地之前经过多个邮件服务器，使用 TLS 将确保它在服务器之间被加密，但是每个服务器都可以改变消息内容。为了解决这个问题，我们创建了 SPF、DKIM 和 DMARC。

## 发件人策略框架

SPF 允许域名所有者(如 google.com)在其 DNS 中设置一个 TXT 记录，说明允许哪些服务器从该域发送邮件(关于如何为各种主机提供商做这件事的说明，请查看[该网站](https://support.knowbe4.com/hc/en-us/articles/115015835387-How-Can-I-Add-a-TXT-Record-to-My-DNS-Records-))。

### 这是如何工作的？

该记录列出了允许的设备(通常按 IP ),并可以下列选项之一结束:

-all =如果检查失败(电子邮件的来源不是列出的设备之一)，结果是硬失败。大多数邮件系统会将这些邮件标记为垃圾邮件。

？all = =如果检查失败(电子邮件的来源不是列出的设备之一)，结果是中性的。这通常用于测试，而不是生产领域。

~all =如果检查失败(电子邮件的来源不是列出的设备之一)，则结果是软失败。这意味着此邮件是可疑的，但不一定是已知的坏消息。一些邮件系统会将这些邮件标记为垃圾邮件，但大多数不会。

SPF 头对服务器本身很有帮助，因为它们正在处理消息。例如，如果服务器在网络的边缘，它知道它接收的消息应该来自发送者的 SPF 记录中的服务器。这有助于服务器更快地清除垃圾邮件。虽然这听起来很棒，但不幸的是，SPF 有几个主要问题。

1.  SPF 不告诉邮件服务器如何处理邮件——这意味着邮件可能无法通过 SPF 检查，但仍然可以传递。
2.  SPF 记录不是查看用户看到的“发件人”地址，而是查看“返回路径”。这基本上相当于你写在信上的回信地址。它告诉处理信件的邮件服务器将消息返回到哪里(它存储在电子邮件标题中——本质上是服务器用来处理电子邮件的技术信息)。这意味着我可以把我想要的任何东西放入 from:地址，而不会影响 SPF 检查。事实上，这两个电子邮件地址都可能被黑客伪造。因为不涉及加密，SPF 头不能被完全信任。
3.  SPF 记录需要不断更新，这在不断变化的大型组织中是很难做到的。
4.  转发破 SPF。这是因为如果一封来自 google.com 的电子邮件被 bob@bobsburgers.com 转发，信封发送者保持不变(发件人地址仍然是 Google . com)。接收邮件的服务器认为它声称来自 google.com，但实际上来自 bobsburgers.com，所以它没有通过 SPF 检查(尽管邮件实际上来自 Google . com)。

更多关于防晒指数的阅读，请看这些 [的文章](http://knowledge.ondmarc.com/en/articles/1148885-spf-hard-fail-vs-spf-soft-fail)。您可以在此查看特定域是否配置了 SPF 和 DMARC 记录[。](https://domain-checker.valimail.com/google.com)

## DKIM(域名密钥识别邮件)

DKIM 类似于 SPF。它还使用发送域的 DNS 中的 TXT 记录，并提供消息本身的某种身份验证。它试图验证消息在传输过程中没有被更改。

### 这是如何工作的？

发送域生成一个公钥/私钥对，并将公钥放入该域的 DNS TXT 记录中(如果您不知道什么是公钥/私钥对，请查看本文中的[。](https://www.freecodecamp.org/news/how-to-send-secret-messages/)

然后，域的邮件服务器(在外部边界——向域外发送邮件的服务器(例如从 gmail.com 到 outlook.com))使用私钥生成整个邮件正文的签名，包括邮件头。

生成签名通常需要对文本进行散列和加密(关于这个过程的更多细节，请查看本文。

接收邮件的服务器使用 DNS TXT 记录中的公钥来解密签名，然后对邮件和相关邮件头(邮件在发件人的基础架构中创建的任何邮件头，例如，如果多个 g mail 服务器在邮件发送到 outlook.com 之前对其进行了处理)进行哈希处理。

然后，服务器将检查以确保这两个散列匹配。如果是这样的话，消息很可能是未经更改的(除非有人泄露了发送者的私钥)，并且是来自声称的发送者的合法消息。如果哈希值不匹配，则消息不是来自声称的发件人，或者在传输过程中被其他服务器更改过，或者两者都有。

DKIM 在一项非常特殊的任务上做得非常好，那就是回答“这封电子邮件是否在传输过程中被修改过，是否来自声称的发件人？”。然而，这就是它所做的一切。它没有告诉你如何处理没有通过这个测试的邮件，哪个服务器可能修改了邮件，或者做了什么修改。

一些 ISP 或互联网服务提供商也使用 DKIM 来确定您的域名的信誉(您是否发送了大量垃圾邮件？你的参与度低吗？你的电子邮件多久被退回一次？).

更多关于 DKIM 的阅读，请查看这篇文章。您可以在这里验证 DKIM 记录[。](https://www.dmarcanalyzer.com/how-to-validate-a-domainkey-dkim-record/)

## DMARC(基于域的消息认证、报告和一致性)

DMARC 本质上是邮件服务器如何处理 SPF 和 DKIM 记录的指令。它自己不执行任何测试，但是它告诉邮件服务器如何处理 SPF 和 DKIM 执行的检查。

参与的 ISP 将查看公布的 DMARC 记录，并使用它们来确定如何处理 DKIM 或 SPF 故障。例如，一个常见的欺骗品牌可能会发布一个 DMARC 记录，上面写着如果 DKIM 或 SPF 失败，则丢弃该消息。

通常，ISP 还会向您发送关于您的域名活动的报告，包括电子邮件的来源以及它是否通过了 DKIM/SPF。这意味着，当有人假冒(声称发自)您的域名或篡改您的邮件时，您将会看到。

为了实现 DMARC，您需要根据您的需求创建一个 DMARC 记录(从监控您的电子邮件流量以找出您所有的电子邮件来源，到要求采取行动，如拒绝任何未通过 DKIM 或 SPF 的电子邮件)。你可以在这里和这里了解更多关于做那件事的[。](https://blog.returnpath.com/build-your-dmarc-record-in-15-minutes-v2/)

更多关于 DMARC 的阅读，请查看本文。您可以在此查看特定域是否配置了 SPF 和 DMARC 记录[。](https://domain-checker.valimail.com/google.com)

## 包裹

这些安全措施没有一个是完美的，但合在一起，它们在帮助我们提高全球电子邮件系统的安全性方面做得相当不错。

越多的组织采用这些措施(要么使用开源实现，要么为产品付费),每个人都会过得越好。在协议或产品开发之后添加的安全性通常比内置于产品中的安全性更昂贵、更低效、更难实现。

然而，当前互联网所依赖的大多数协议都是为早期的互联网设计的——为一小群爱好者、科学家和政府官员设计的——而不是一个我们在其上运行建筑、智能设备、公共交通、核电站(！idspninfopath)的全球网络。)，等等。

因此，随着互联网的不断发展，我们需要不断适应和开发新的方法来保护我们所依赖的系统。