# 我是如何发现 C# SortedList 使用二分搜索法的，以及为什么您应该关注它

> 原文：<https://www.freecodecamp.org/news/how-i-discovered-c-sortedlist-uses-binary-search-and-why-you-should-care-a88cce40f49b/>

作者:Rina Artstain

# 我是如何发现 C# SortedList 使用二分搜索法的，以及为什么您应该关注它

有一个古老的争论:程序员仅仅知道如何编码就可以了吗？或者他们需要了解一些他们的框架内部结构、基本数据结构和搜索/排序算法吗？

我遇到过许多由于不知道哈希表是如何实现的而产生的错误。或者是一个小小的疏忽，对于不知道二分搜索法存在的人来说，这完全是个谜。所以你可能会猜测，我认为你必须具备基本的数据结构/算法知识。我希望读完这篇文章后你会同意我的观点——但是如果不同意，你可以在下面的评论区留下你的不同意见。

![1*wnTXS4cPw-Tw_oC79VweTQ](img/488c45553aebd809b542045b780f09b5.png)

### 系统概况

想象一下一个由客户服务代表组成的系统，在这个系统中，每个用户都要写笔记来跟踪客户的行为和对话。如果便笺需要将来的操作，用户可以为特定的日期和时间添加一个截止日期，这就变成了一个“任务”在任何时候，用户都可以将该任务标记为“完成”，该任务将被移除，同时保留在笔记列表中。

为了便于访问，所有便笺都按插入日期降序显示(最早的便笺在最前面)。任务按截止日期升序显示(即将到来/过期的任务优先)。

像往常一样，为了简单起见，省略了原始系统的一些复杂性(持久性、多线程等)。).我还提供了一个 GitHub 的链接，其中包含了这篇文章中的代码的工作版本。你可以自己经营。(它在文章的底部，所以即使你没有阅读它，你也必须一路向下滚动哈！).

### 履行

让我们从注释类定义开始:

这是一个简单的数据对象。

接下来，我们将创建一个 NotesManager 类，它保存所有的笔记/任务并管理对它们的访问:

NotesManager 类使用一个 SortedList 来保持 Notes/Tasks 的正确顺序，该顺序由列表的类型和给 NoteComparer 的 SortDirection 决定。笔记按插入日期升序排列，任务按截止日期降序排列。NotesManager 类负责创建带有正确日期的 NoteIndex。它会在适当的列表中插入注释。

我们需要的最后一个功能是将任务标记为“done”，然后从任务列表中删除该任务。

我写这段代码的时候在想什么？我真的不记得了。可能什么都没想。这是许多错误的根本原因。

在继续阅读之前，花一秒钟的时间，试着找出问题所在。

### 这是怎么回事？

想象一下当我开始测试 NotesManager 时我有多惊讶。我发现，当我将一些任务标记为“完成”时，它们并没有从任务列表中删除。它看起来完全是随机的，有时有效，有时无效。

我站在那里，难以置信地盯着调试器。任务就在任务列表中的处，但是“移除”并没有移除它。我不知道发生了什么。

我假设 NoteComparer 实现有问题。我在 Compare 方法中添加了一个断点。在那里，我发现了一些奇怪的事情:任务没有被顺序扫描。调试器似乎在随机访问任务列表中的项目。

嗯嗯。奇怪。有一秒钟，我认为可能会有一些多线程的怪异之处，但这是一个本地开发环境——没有其他人可以访问我的 web 服务器(如果有，他们测试我当前使用的同一个用户和数据的可能性有多大？).不，答案一定在别的地方。

又做了几次测试后，一个模式出现了。要比较的第一个访问位于列表的中间。然后它跳到了另一个位置。然后一跳又一跳，最后放弃了整件事。然后#facepalm 时刻到来了，我意识到 SortedList 必须使用二分搜索法来查找列表中的项目！这应该是显而易见的(其他任何事情都是愚蠢的，真的)。

我试图通过搜索 [MSDN 文档](https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.sortedlist-2?view=netframework-4.7.2)来验证我的想法，结果是——[移除](https://docs.microsoft.com/en-us/dotnet/api/system.collections.generic.sortedlist-2.remove?view=netframework-4.7.2#System_Collections_Generic_SortedList_2_Remove__0_)使用二分搜索法。好吧，那么我的猜测是对的——但是为什么二分搜索法**不工作**？

这一次，我在比较器实现中将断点向下移动了一点。我立刻看出了问题所在。我只传递了带有 Id 的 NoteIndex，假设这样就足够了。

如果这是一个常规的列表，那就可以了。但是结合二分搜索法(而不是我隐含假设的顺序扫描)切掉那个角，导致 SortedList 无法找到它要找的笔记。所以我改了“MarkDone”的实现。

而且成功了！

(这个实现中也有一个 bug，但是我想把重点放在手头的问题上。你能发现问题吗？)

你可以在这里下载一个展示这个 bug 及其解决方案的工作示例[。](https://github.com/rinaarts/NoteSystem)

### 关键要点

以下是我从这个案例中得到的主要收获:

1.  如果您正在使用新的服务或数据结构，请花 5 分钟阅读文档。如果我那样做了，并且意识到 SortedList 上的键是用于惟一性而不仅仅是排序的，我可能就不会犯这样的错误了。
2.  对于日常工作来说，很好地掌握基本的数据结构和算法是必不可少的。这种类型的 bug 极难发现和解决。它偶尔发生，没有明显的逻辑。最好完全避免这种类型的错误，但是如果你不能避免，至少能够在它发生后进行分析。

### 额外问题

为什么我在 Note 类上重写 GetHashCode()。如果您已经重写了 Equals()，为什么您应该总是重写 GetHashCode()？

提示:哪种数据结构使用散列码？

喜欢你读的吗？鼓掌分享爱。有问题或意见吗？请在评论区告诉我。