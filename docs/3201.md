# 为什么不应该使用 AWS S3 或 CloudFront 来交付静态资产

> 原文：<https://www.freecodecamp.org/news/do-not-use-s3-for-static-assets/>

AWS 是镇上最酷的孩子。不同云提供商的每一次比较都是不完整的，除非你至少和 AWS 比较过一次。

但是 S3，最流行的云存储解决方案，也是每个人都喜欢的解决方案，不应该总是你的选择。在这篇文章中，我将解释为什么。

***注:**请不要马上对我大喊 AWS 如何以及为什么最好。我知道他们处于云计算的顶端——我绝不是想针对他们的任何商业实践和服务。*

*我自己刚刚用了 CloudFront + S3，也用了 DigitalOcean + Cloudflare，并把我的观察记录了下来。请建设性地采纳我的想法，如果你认为我犯了什么错误，请发微博给我。*

## 云锋+ S3

当你试图在全球范围内以数字方式分发文件时，CloudFront 是 S3 经常使用(也是推荐)的另一项服务。CloudFront 是亚马逊的 CDN，边缘服务器遍布全球。它是这样工作的:

你的用户，比如说来自印度的用户，试图加载你的服务器位于美国的网站。比如说你用的是 React 或者 Angular 之类的 SPA。第一个 index.html 页面将从您的原始服务器加载(从不缓存 HTML 页面通常是一个好习惯，尤其是如果您使用 SSR 应用程序来防止缓存灾难)。

在那之后，如果你已经在 CloudFront (S3)上托管了你的 JS/CSS 文件，这些调用将从 CloudFront 的一个域名发出，该域名解析为离你最近的一台机器的 IP 地址。在这种情况下，它可能是位于印度孟买某个数据中心的 AWS 服务器。

从这一点来说，该服务器有责任提供该文件。可能会发生两件事:

*   你的文件在孟买的服务器上已经是可用的了(缓存的)，并且那个服务器立即把那个文件返回给你(缓存命中)，
*   或者它没有那个文件，必须到您的原始服务器(在这种情况下是 S3 桶)去获取那个文件。

但是，即使有缓存未命中，与前面没有 CloudFront 相比，对用户来说仍然更快的可能性很高。

为什么？因为当出现缓存未命中，边缘服务器试图到达主服务器时，它使用的是亚马逊——一家市值万亿美元的美国公司——运营的一级互联网连接线。他们的互联网连接和延迟可能比你的 ISP 提供的要好得多。

此外，因为他们在同一个全球亚马逊网络上，他们可以做一些简单的优化来节省更多的时间。

好吧！到目前为止，我觉得听起来不错，那还有什么问题呢？别急，我们马上就去。

# 资产压缩

CloudFront 允许您使用 GZIP 交付压缩资产。但是市场上还有一个更酷的孩子:brotli compression。而且几乎每个主流浏览器都支持。

Brotli 会进一步压缩您的传输数据。这意味着它不仅对你的钱包有好处，而且对最终用户也有好处(因为他们看到加载/白屏的时间会更少)。

Amazon CloudFront 还不支持 brotli 压缩交付。我也不会为此责怪他们。这是因为 brotli 压缩在运行时很慢(CloudFront 在运行时执行 gzip)，所以他们还没有实现它。

当然，然后让我们自己做它并且在 S3 上存储它并且递送压缩的版本，对吗？不幸的是，这并不简单，我们很快就会归结为一个架构问题。

典型的资产 URL 如下所示:http://my site/assets/JavaScript/file . js

当您的浏览器发出请求时，它会发送一个标头:Accept-Encoding。这个头可以包含你的浏览器可以支持的压缩算法，比如 gzip，deflate，brotli 等。服务器现在必须表现得更聪明，以获得最高的效率。

1.  如果客户端支持 brotli，那么总是交付 brotli 压缩资产。
2.  如果客户端支持 gzip，那么总是交付 gzip。
3.  否则，交付原始文件。
4.  此外，确保在响应类型中设置了正确的内容编码，以便浏览器可以识别压缩算法。

现在，首先，您必须为每个资产文件创建 3 个变量:

1.  file.js
2.  file.js.br - brotli
3.  file.js.gz-gzip

你必须根据浏览器是否支持来有条件地发送它们。CloudFront 是一个“哑”CDN——它只会将你的请求 URL 映射到你服务器上的文件。它不能执行任何转换，除非....你选择了另一项 AWS 服务- Lambda@edge functions

我们可能都知道 AWS 上的 Lambda 是什么——你可以在云上运行功能，而不用担心底层基础设施的升级或降级。根据 API 请求定价，有时间限制，甜蜜。Lambda@edge 是一项类似的服务，但它是为边缘服务器(CloudFront CDN 数据中心)设计的

从技术上来说，您可以配置一个 Lambda 服务器，作为客户端请求和 CloudFront CDN 之间的“中间人”。Lambda 可以打开请求，查看支持的内容头，相应地修改 URL，并将其转发给“哑”CloudFront，CloudFront 将检索修改后的 URL 文件。

例如，如果 lambda 看到 browser 发送了一个 Accept-Encoding: br，那么 Lambda 可以用来将请求 URL 从/javascript/file.js 修改为/javascript/file.js.br，而不需要实际通知用户端。Cloudfront 现在将检索一个较小的有效负载，并返回一个 brotli 编码的响应。赢了！

但这很好，不是吗？问题出在哪里？问题是...定价。

## AWS 贵得离谱(对于这项任务)

不管你现在做了什么，听起来和看起来都很好。但是当你看到当你开始达到显著数字时会发生什么，你会意识到 AWS 在数据传输方面并不出色。 [Zoom 刚刚因为同样的原因](https://www.lastweekinaws.com/blog/why-zoom-chose-oracle-cloud-over-aws-and-maybe-you-should-too/)退掉了 AWS。

此外，随着资产压缩，现在您还必须为 Lambda@edge 调用付费。我发现实现 Lambda@edge 实际上会降低您的成本，否则您将为 AWS 的流量支付更多费用！

CloudFront 致力于数据转移定价。当它从 S3 存储桶中检索数据时不收费，当用户从边缘服务器中检索数据时收费。

## 成本上限

在最贵的国家——印度——CloudFront 向你收取每 GB 传输数据 0.170 美元的费用。这是巨大的！

假设您有一个受欢迎的(主要是)印度网站，每天大约有 50，000 名用户访问您的网站。另外，假设你每周都在你的站点上做一些设计变更(对于快速迭代的产品来说很常见)，那么你必须使浏览器和 CloudFront 缓存失效。

另外，让我们假设平均来说，单个用户通过 CloudFront 从 S3 托管的站点(包括 CSS/JS/images/fonts)下载大约 10MB 的静态资产。

让我们来计算一下成本:

1.  5 万印度用户
2.  每 GB 0.17 美元
3.  10MB per user
4.  每个用户每月检索 4 次(你刷新你的缓存 4 次——每周一次)

成本= 50000 * 0.17 * (10/1024) * 4 = 332 美元。这就是你的数据传输成本！我没有计算 S3 存储成本和托管站点成本。(我也没有包括 lambda 定价，因为它不多=> $(0.20 * (50，000 * 4))/100 万= 4 美分。)

## 成本下限

在这种情况下，让我们假设一个基于美国的交通网站。现在的参数是:

1.  5 万美国用户
2.  每 GB 0.085 美元
3.  3 MB per user
4.  每个用户每月检索 4 次(你刷新你的缓存 4 次——每周一次)

成本= 50000*0.085*3*4/1024 = 50 美元。这是你在使用 CloudFront 处理上述流量时支付的最低价格(假设你所有的 50K 用户都来自美国)。请记住，这只是数据传输的成本！(不包括托管您网站的服务器成本。)

## 供选择的

假设现在你只在主服务器上托管所有这些静态资产——由 NGiNX 反向代理，运行在一个 60 美元的 DigitalOcean 实例上。

您每月的数据传输量= 50000 * (10/1024) * 4 = 1952 GB 大约 2TB - DigitalOcean 免费为您的每一滴数据传输量支付 1TB 的费用。从那时起，每 1TB 的价格是 10 美元，因此运行服务器的净价是 70 美元。

当然，你现在会有一些延迟——因为你自己在托管它(我们甚至会在以后解决这个问题)。NGiNX 是一个高性能的 web 服务器，你可以相信它不会成为静态资产交付的瓶颈。

因此，您刚刚将运行整个服务器的“仅资产转移”成本从 332 美元降至 70 美元！额外小费？我们只专注于在印度运行，所以使用印度的数字海洋服务器。这将意味着更少的延迟。

不仅如此，您还可以选择免费的 Cloudflare CDN。如果文件太大或不常访问，Cloudflare 不会考虑将它们保存在 CDN 中。但我们假设这是一个非常受欢迎的网站，所以我们应该没问题。如果没有，选择任何其他的 CDN 服务，我向你保证每月不到 332 美元。

TL；DR——如果你在托管一个流量中等且定期更新的网站，那么自己托管资产并使用外部 CDN(或甚至像 DigitalOcean CDN 这样的东西)比使用 S3 和 CloudFront(数据流量率极高)更具成本效益。

## 结论

我在 codedamn.com 使用了这个设置(CloudFront + AWS S3)，这是一个开发者学习和成长的平台。我很快意识到，虽然它看起来很花哨，而且我已经把 codedamn 放入了大联盟——亚马逊——但它的效率还不够。

你同意我的观点吗？你怎么想呢?通过在我的推特上发微博或者在 T2 的 Instagram 上联系我，让我知道。

和平！