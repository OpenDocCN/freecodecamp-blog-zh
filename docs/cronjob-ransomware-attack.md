# 一个简单的 cron 作业如何将您从勒索软件攻击中解救出来

> 原文：<https://www.freecodecamp.org/news/cronjob-ransomware-attack/>

现在是 2019 年，勒索软件已经成为一种东西。

与公众互动的系统，如公司、教育机构和公共服务，最容易受到影响。虽然勒索软件的传送方法各不相同，从物理领域到通过社交网站和电子邮件的通信，但所有方法都只需要一个人犯一个错误，勒索软件就会激增。

你可能已经听说过，勒索软件是一种恶意程序，它会加密你的文件，使它们对你来说不可读和无用。它可以包括支付赎金的指令，通常通过发送加密货币来获得解密密钥。

成功的勒索软件攻击通常利用重要的、时间敏感的系统。像公共服务和医疗设施这样的受害者更有可能恢复过程很差或为零，让政府或保险提供商用赎金奖励攻击者。

个人，尤其是不太懂技术的人，同样面临风险。勒索软件可以屏蔽可能只存在于一台机器上的个人文档和家庭照片。

幸运的是，有一个技术含量相当低的解决方案可以让勒索软件变得无能:备份你的数据！

你可以用一个简单的系统来实现这一点，比如插上一个外部硬盘，每天拖一次文件过来，但是这种方法有一些障碍。手动传输文件可能会很慢或不完整，此外，你首先要记住这样做。

## 相反，使用 cron

在我不断追求自动化的过程中，有一个工具因其简单性和可靠性而经常被我使用:`cron`。Cron 只做一件事，而且做得很好:它按计划运行命令。

我第一次使用它是在三年前的几个月前(我写博客真的有那么久吗？！)在 Linux 上创建[自定义桌面通知](https://victoria.dev/blog/how-i-created-custom-desktop-notifications-using-terminal-and-cron/)。使用 crontab 配置文件(可以通过运行`crontab -e`进行编辑),可以指定运行任何命令的时间表。下面是调度语法的样子，来自[维基百科 cron 页面](https://en.wikipedia.org/wiki/Cron):

```
# ┌───────────── minute (0 - 59)
# │ ┌───────────── hour (0 - 23)
# │ │ ┌───────────── day of the month (1 - 31)
# │ │ │ ┌───────────── month (1 - 12)
# │ │ │ │ ┌───────────── day of the week (0 - 6) 
# │ │ │ │ │
# │ │ │ │ │
# │ │ │ │ │
# * * * * * command to execute
```

例如，每天 00:00 运行的 cron 作业如下所示:

```
0 0 * * *
```

要每 12 小时运行一次作业，语法如下:

```
0 */12 * * *
```

这个[伟大的工具](https://crontab.guru/)可以帮助你理解 cron 调度语法。

调度程序与备份有什么关系？本身，不多。cron 的简单之处在于它可以运行命令——任何 shell 命令，以及通常在命令行上运行的任何脚本。正如你可能已经从我的其他帖子中收集到的，我强烈认为你可以在命令行上做任何事情，包括备份你的文件。这一领域的存储选项非常丰富，从近乎免费的本地和云选项，以及不胜枚举的付费托管服务。对于 CLI 工具，我们有实用的经典工具，如`rsync`，以及针对特定云提供商的 CLI 工具，如 AWS。

## 使用`rsync`备份

[`rsync`实用程序](https://en.wikipedia.org/wiki/Rsync)是一个经典的选择，它可以将您的文件备份到外部硬盘或远程服务器，同时智能地决定要更新哪些文件。它使用文件大小和修改时间来识别文件更改，然后只传输已更改的文件，从而节省时间和带宽。

[`rsync`的语法](https://download.samba.org/pub/rsync/rsync.html)可能有点细微差别；例如，尾随的正斜杠将只复制目录的内容，而不是目录本身。我发现例子有助于理解用法和语法。

这里有一个用于将本地目录备份到本地目标，如外部硬盘驱动器:

```
rsync -a /home/user/directory /media/user/destination
```

第一个参数是源，第二个参数是目的。在上面的例子中，将文件从挂载的驱动器复制到本地主目录。

存档模式的`a`标志是`rsync`的超能力之一。相当于旗帜`-rlptgoD`，它:

*   通过目录递归同步文件(`r`)；
*   保留符号链接(`l`)、权限(`p`)、修改时间(`t`)、组(`g`)和所有者(`o`)；和
*   复制设备和特殊文件(`D`)。

下面是另一个示例，这次是使用 SSH 将本地目录的内容备份到远程服务器上的目录:

```
rsync -avze ssh /home/user/directory/ user@remote.host.net:home/user/directory
```

`v`标志打开详细输出，如果您喜欢关于哪些文件正在被传输的实时反馈，这很有帮助。然而，在大型传输中，它可能会减慢速度。`z`标志可以对此有所帮助，因为它表示文件在传输过程中应该被压缩。

`e`标志，后跟`ssh`，告诉`rsync`根据最后一个参数中提供的目的地指令使用 SSH。

## 使用 AWS CLI 备份

Amazon Web Services 提供了一个命令行界面工具，可以完成 AWS 设置的所有工作，包括一个简单的 [`s3 sync`命令](https://docs.aws.amazon.com/ja_jp/cli/latest/reference/s3/sync.html)，用于将新的和更新的文件递归复制到 S3 存储桶中。作为备份数据的存储方法，S3 是一种稳定且廉价的选择。

与目录交互的[语法相当简单，您可以直接将您的 S3 桶作为`s3://mybucket/mykey`形式的`S3Uri`参数。要将本地目录备份到您的 S3 存储桶，命令是:](https://docs.aws.amazon.com/ja_jp/cli/latest/reference/s3/index.html#directory-and-s3-prefix-operations)

```
aws s3 sync /home/user/directory s3://mybucket
```

类似于`rsync`，颠倒源和目的地将从 S3 桶下载文件。

默认情况下，`sync`命令是直观的。它将猜测上传文件的 mime 类型，以及通过跟踪符号链接发现的包含文件。存在各种选项来控制这些和其他缺省值，甚至包括指定要使用的服务器端加密的标志。

## 设置您的 cronjob 备份

您可以通过运行以下命令来编辑您的计算机的 cron 文件:

```
crontab -e
```

虽然很直观，但值得一提的是，备份命令只有在计算机打开并且 cron 守护进程正在运行时才会运行。记住这一点，为您的 cronjob 选择一个与您的机器开机时间一致的时间表，并且不要让其他工作过载。

例如，要在每天早上 8 点备份到一个 S3 存储桶，您应该在 crontab 中放一行，如下所示:

```
0 8 * * * aws s3 sync /home/user/directory s3://mybucket
```

如果您想知道 cron 作业当前是否正在运行，请使用以下命令查找 cron 的 PID:

```
pstree -ap | grep cron
```

然后运行`pstree -ap <PID>`。

这个兔子洞更深；快速搜索可以揭示组织和调度 cronjobs 的不同方式，或者帮助您找到不同的实用程序，以便在计算机休眠时运行 cronjobs。为了防止受勒索软件影响的文件被转移到您的备份中，增量分离归档是一个好主意。然而，本质上，这种基本的设置是创建一个可靠的自动备份系统所需要的。

## 不要喂巨魔

人类是会犯错的；这就是网络攻击奏效的原因。勒索软件攻击的成功取决于受害者别无选择，只有付钱才能恢复正常业务。

一个高度可访问的最新备份削弱了那些认为我们毫无准备的攻击者。通过摧毁一个系统并从昨天的备份中恢复，我们可能会失去一天的进展；然而，勒索者什么也得不到。

为用户和组织提供更多关于勒索软件防御的资源，查看 [CISA 关于勒索软件的建议](https://www.us-cert.gov/Ransomware)。