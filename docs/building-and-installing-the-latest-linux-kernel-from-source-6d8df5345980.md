# 如何从源代码构建和安装最新的 Linux 内核

> 原文：<https://www.freecodecamp.org/news/building-and-installing-the-latest-linux-kernel-from-source-6d8df5345980/>

作者:斯雷哈里

# 如何从源代码构建和安装最新的 Linux 内核

![vhT5bdwE6q7On0anit1Gisram0a5-Hm6AsUb](img/907ca8e82c8765e5b8f5162e4dae98f3.png)

A map of the Linux kernel

我刚刚完成了高级操作系统课程的第一个作业。我决定记录我从源代码构建 Linux 内核和实现我自己的系统调用的方法。

有一些博客已经告诉你如何着手做这件事，但是其中一些已经过时，一些看起来不必要的复杂。我的目标是提出一种简单的方法来做到这一点，希望能帮助您节省大量时间。

从源代码中编译 Linux 内核似乎是一项令人生畏的任务，即使对于那些对计算机相当熟悉的人来说也是如此。如果你没有按照正确的指示去做，也会变得很烦人。

所以，这里有一个指南可以帮助你从源代码开始构建内核的过程，而且是一个有效的指南！你将不必担心搞乱你的系统或浪费你的时间。

### 为什么要从源代码构建内核？

如果您计划在 Linux 内核的内部工作或者改变它的行为，您将需要在您的系统上重新编译内核。

这里有几个具体的例子，您需要知道如何使用内核的源代码:

1.  你想写一个非常酷的“Hello world”程序。(每次您[实现您自己的系统调用](https://medium.com/@ssreehari/implementing-a-system-call-in-linux-kernel-4-7-1-6f98250a8c38#.wjl4xo6hx)或者修改内核源代码时，您将需要重新编译内核来实现更改)
2.  您想要在您的内核上启用默认情况下没有启用的实验性特性(或者，禁用您不想要的默认特性)
3.  您想要调试内核源代码，启用对新硬件的支持，或者对其现有配置进行修改
4.  你正在学习高级操作系统课程，除此之外别无选择！

在上述每种情况下，学习如何从源代码构建内核将会派上用场。

### 你需要什么

一个基于 Linux 的操作系统(我在 Ubuntu 14.04 LTS 上试过，这里写的说明也是一样的)。

在开始之前，您需要安装几个软件包。使用以下命令进行相同的操作。

```
sudo apt-get update
```

```
sudo apt-get install git fakeroot build-essential ncurses-dev xz-utils libssl-dev bc
```

您还需要至少 12 GB 的可用磁盘空间、下载源代码的互联网连接和大量时间(大约 45 到 90 分钟)。

### 下载并提取最新的内核源代码

要检查您当前的内核版本，请打开终端并键入:

```
uname -r
```

去[kernel.org](https://www.kernel.org/)下载最新稳定版。在撰写本文时，最新的稳定内核版本是 4.7.1，我将在本文中引用相同的版本。(注意:尽量避免从其他网站下载源代码)

切换到下载文件的目录，并使用以下命令提取:

```
tar xf linux-4.7.1.tar.xz
```

转到解压缩的 linux-4.7.1 目录。

```
cd linux-4.7.1
```

它应该包含名为 **arch** 、 **fs** 、 **crypto** 等文件夹。

#### 配置和编译:

在编译内核之前，我们需要配置哪些模块要包含，哪些要省略。

有许多方法可以着手做这件事。

一种简单直接的方法是首先复制现有的内核配置文件，然后使用“menuconfig”进行更改(如果需要)。这是最快的方法，也可能是最安全的。

```
cp /boot/config-$(uname -r) .config 
```

```
make menuconfig
```

在这一部分，您可能会取消对设备驱动程序的支持，或者做一些最终会导致内核崩溃的事情。如果您不确定是否要进行更改，只需保存并退出。

注意:menuconfig 的替代方法之一是使用“make config”访问交互式命令行界面。这有助于您从头开始配置一切。不要使用这个。你会被问到上千个关于启用或禁用模块的是/否问题，我保证这一点都不好玩。我确实试过一次，不知怎么搞砸了显示驱动配置。

gconfig 和 **xconfig** 是您可以使用的基于 GUI 的替代配置工具。我自己没试过这些。为此，您需要使用 **make gconfig** (或 **make xconfig** )而不是 **make menuconfig** 。

现在，我们都准备好了！

为了编译内核及其模块，我们使用了 **make** 命令。

接下来使用 **make modules_install** 来安装内核模块。

最后，我们使用 **make install** 来复制内核和。config 文件复制到/boot 文件夹，并生成 system.map 文件(这是内核使用的一个符号表)。

这三个步骤加在一起通常会占用很多时间。使用以下命令执行上述任务:

```
sudo make -j 4 && sudo make modules_install -j 4 && sudo make install -j 4
```

注意:我使用了-j 选项来指定要使用的内核数量。这往往会大大加快这一进程。您可以使用 **nproc** 来检查可用处理单元的数量。在我的例子中，它是 4 个核心。

理想情况下，您不应该需要 sudo 特权，但是，当我没有使用 sudo 特权运行它时，我遇到了问题。

### 最后的步骤

一旦内核及其模块被编译和安装，我们希望在下次启动时使用新的内核。

为此，我们需要使用以下命令:

```
update-initramfs -c -k 4.7.1 
```

然后，使用下面的命令，它会自动查找/boot 文件夹中的内核，并将它们添加到 grub 的配置文件中。

```
update-grub 
```

现在，重新启动系统，您应该会看到新的内核被添加到引导加载程序条目中。

按照说明，假设磁盘上有足够的可用空间，并且当前内核配置工作正常，您应该不会遇到任何问题。请注意，在出现任何问题的情况下，您可以始终使用旧的内核版本，并再次尝试全部内容！

命令 **uname -r** 现在应该显示当前使用的内核版本。

### 重要的一点

第一次从源代码构建内核需要以上步骤。一旦这至少完成了一次，新的内核映像就准备好了，进行修改和编写我们自己的模块就很简单了。每次要实施新的东西或进行不同的配置时，您将只使用**配置和编译**下列出的步骤。

意，只要记住以下几点:

```
cp /boot/config-$(uname -r) .config
```

```
make menuconfig
```

```
sudo make -j 4 && sudo make modules_install -j 4 && sudo make install -j 4
```

我必须感谢以下有价值的资源——它们对这项任务帮助很大:[Ramkitech.com](http://www.ramkitech.com/)、[askubuntu.com](http://askubuntu.com/)、[kernel.org](http://www.kernel.org/)和 [cyberciti.biz](http://www.cyberciti.biz/)