# 持续集成和持续部署的真正区别

> 原文：<https://www.freecodecamp.org/news/the-real-difference-between-ci-and-cd/>

有大量的内容描述了什么是持续集成、持续交付和持续部署。但是这些过程最初是为了什么目的呢？

理解 CI 和 CD 解决的问题是正确使用它们的关键。这将允许您的团队改进您的过程，并避免将精力放在追逐对您的过程没有任何价值的花哨的度量上。

## 持续集成是一个团队问题

如果您在一个团队中工作，有可能有几个开发人员在同一个存储库上工作。存储库中有一个主分支，承载着最新版本的代码。开发人员在不同的分支从事不同的工作。一旦有人完成了他们的变更，他们会将它推送到或者合并到主分支。最终，整个团队都会做出改变。

我们希望避免的情况是错误的提交进入主分支。故障意味着代码无法编译，或者应用程序无法启动或不可用。为什么？不是因为应用程序坏了，也不是因为所有测试都必须是绿色的。这不是问题——您可以决定不部署该版本，等待修复。

问题是你的整个团队都卡住了。所有提交错误提交的开发人员将会花 5 分钟的时间思考为什么它不工作。有些人可能会试图找到错误的提交。一些人会尝试自己解决问题，就像错误代码的作者一样。

这对你的团队来说是浪费时间。最糟糕的是，重复的事件加剧了对主要分支的不信任，并鼓励开发人员分开工作。

> 持续集成是为了防止主分支断裂，这样你的团队就不会被卡住。就是这样。让所有的测试始终保持绿色，并在每次提交时将主分支部署到生产环境中，这不是**而不是**。

持续集成的过程独立于任何工具。您可以手动验证您的分支和主分支的合并在本地工作，然后实际上将合并推送到存储库。但是那样效率会很低。这就是为什么持续集成是使用自动化检查来实现的。

这些检查至少确保:

*   该应用程序应该建立和启动
*   最关键的功能应该在任何时候都可以使用(用户注册/登录过程和关键业务功能)
*   所有开发人员依赖的应用程序的公共层应该是稳定的。这意味着对那些部分进行单元测试。

在实践中，这意味着您需要使用任何适合您的单元测试框架，并保护应用程序的公共层。有时候没有那么多代码，可以很快完成。此外，您需要添加一个“冒烟测试”来验证代码是否编译以及应用程序是否启动。这在像 Java Spring 或。网芯。在大型项目中，很容易混淆依赖关系，因此验证应用程序是否总是启动是必须的。

> 如果你有成百上千的测试，你不需要每次合并都运行它们。这将花费很多时间，而且大多数测试可能会验证“非团队阻断器”特性。

我们将在接下来的章节中看到持续交付的过程将如何很好地利用这些测试。

### 这不是工具的问题

工具和自动化检查都可以。但是如果你的开发者只是合并他们工作了几个星期的巨大分支，他们不会帮助你。团队将花费大量时间合并分支并修复最终会出现的代码不兼容性。这和被错误的提交阻塞一样浪费时间。

> 持续集成与工具无关。它是关于在小块中工作，将新代码集成到主分支中，并且频繁地拉动。

频繁意味着至少每天一次。把你正在做的任务分成更小的任务。经常合并你的代码，经常拉。这样，没有人会分开工作超过一两天，问题也没有时间变成雪球。

大型任务不需要全部在一个分支中。永远都不应该。将进行中的工作合并到主分支的技术被称为“抽象分支”和“特性切换”。参见博客文章[如何开始持续集成](https://fire.ci/blog/how-to-get-started-with-continuous-integration/)了解更多细节。

### 良好 CI 构建的关键点

很简单。保持简短。最多 3-7 分钟。不是 CPU 和资源的问题。这是关于开发人员的生产力。生产力的第一条规则是专注。做一件事，完成它，然后转向下一件事。

上下文切换代价很高。研究表明，当你被打扰时，需要大约 23 分钟来重新集中注意力。

想象你推动你的分支合并它。你开始另一项任务。你花 15-20 分钟进入其中。在您进入该区域后的一分钟内，您会收到一个“构建失败”的通知，该通知来自您为前一个任务构建的长达 20 分钟的 CI 构建。你回去把它修好。你再按一次。来回移动，你轻而易举地损失了 20 多分钟。

> 用你团队中开发人员的数量乘以每天一到两次 20 分钟...浪费了很多宝贵的时间。

现在想象一下，如果反馈在 3 分钟内出现。你可能根本就不会开始这项新任务。在等待的时候，你可能需要再读一遍你的代码或者检查一下你的简历。失败的通知将会出现，您可以修复它。然后你可以继续下一个任务。这就是你的过程应该支持的那种焦点。

保持你的 CI 建设短，使它成为一个权衡。在 CI 环境中运行时间较长或价值不大的测试应该移到 CD 步骤中。是的，那里的故障也需要修复。但是因为他们没有阻止任何人做他们的事情，所以当你完成你正在做的事情时，你可以把修复作为“下一个任务”。只要在工作时关闭通知，并不时查看。尽量减少上下文切换。

## 持续交付和部署是工程问题

让我们先确定一下定义，以便解决这个问题。

**持续交付**是指能够在任何时候部署任何版本的代码。在实践中，它意味着你的代码的最后或前最后版本。您不会自动部署，通常是因为您不需要或者受到项目生命周期的限制。但是一旦有人喜欢，部署可以在最短的时间内完成。某个人可以是希望在试运行或预生产环境中进行测试的测试/QA 团队。或者实际上是时候将代码投入生产了。

连续交付的思想是准备尽可能接近您想要在您的环境中运行的工件。这些都可以。罐子还是。如果您使用的是 Java，则是 war 文件；如果您使用的是. NET，则是可执行文件。这些文件也可以是编译好的 JS 代码的文件夹，甚至是 Docker 容器，只要能使部署更短就行(即，您已经预先构建了尽可能多的内容)。

我所说的准备工件，并不是指把代码变成工件。这通常是几个脚本和几分钟的执行。准备意味着:

> 尽可能运行所有的测试，以确保一旦部署，代码将实际工作。运行单元测试、集成测试、端到端测试，甚至性能测试，如果你能自动化的话。

通过这种方式，您可以筛选出主分支的哪些版本实际上已经准备好生产，而哪些版本还没有准备好。理想的测试套件:

*   确保应用程序的关键功能正常工作。理想情况下，所有功能
*   确保没有性能交易破坏者被引入，所以当你的新版本击中你的许多用户，它有机会持续下去
*   试运行您的代码需要的任何数据库更新，以避免意外

它不需要非常快。30 分钟或 1 小时是可以接受的。

**下一步是持续部署**。您将最新的、生产就绪的代码版本部署到某个环境中。如果你足够信任你的 CD 测试套件，这是理想的产品。

请注意，根据上下文的不同，这并不总是可能的，也不值得付出努力。连续交付通常足以提高工作效率，尤其是如果您在一个封闭的网络中工作，并且可以部署的环境有限。也可能是软件的发布周期阻止了计划外的部署。

持续交付和持续部署(从现在开始姑且称之为 CD)不是团队问题。它们是关于在执行时间、维护工作和测试套件的相关性之间找到正确的平衡，以便能够说“这个版本像它应该的那样工作”

这是一种平衡。如果你的测试持续了 30 个小时，那就是一个问题。参见[这篇关于 Oracle 数据库测试套件的文章](https://news.ycombinator.com/item?id=18442941)。但是如果你花了太多的时间来保持你的测试与最新的代码同步，以至于阻碍了团队的进展，那也不好。同样，如果你的测试套件不能保证任何东西...基本没啥用。

在理想的情况下，我们希望对主分支的每个提交都有一组可部署的工件。您可以看到我们有一个垂直的可伸缩性问题:我们从代码转移到工件的速度越快，我们就越准备好部署最新版本的代码。

## 区别大吗？

持续集成是一个水平可伸缩性问题。您希望开发人员经常合并他们的代码，这样检查就必须很快。理想情况下在几分钟之内，以避免开发人员在 CI 构建的高度异步反馈下一直切换上下文。

开发人员越多，在所有活动分支上运行简单检查(构建和测试)所需的计算能力就越强。

> **一个好的 CI 构建:**

> 确保没有破坏基本内容和妨碍其他团队成员工作的代码被引入到主分支中，并且

> 足够快，可以在几分钟内为开发人员提供反馈，以防止任务之间的上下文切换。

连续交付和部署是垂直可伸缩性问题。你有一个相当复杂的手术要做。

> **一个好的 CD 版本:**

> 确保尽可能多的功能正常工作。

> 越快越好，但这不是速度的问题。30-60 分钟的构建是可以的。

一个常见的误解是将 CD 视为类似 CI 的水平可伸缩性问题:从代码转移到工件的速度越快，实际上可以处理的提交就越多，就越接近理想的场景。

但是我们不需要那个。尽可能快地为每次提交生成工件通常是多余的。你可以尽最大努力接近 CD:有一个单一的 CD 构建，一旦一个给定的构建完成，它将选择最新的提交来验证。

不要误解 CD。真的很难。获得足够的测试信心来说你的软件已经可以自动部署了，这通常适用于像 API 或简单 ui 这样的底层应用程序。在复杂的用户界面或大型的整体系统上很难实现。

## 结论

用于执行 CI 和 CD 的工具和原则通常非常相似。尽管目标非常不同。

持续集成是对开发人员的反馈速度和您执行的检查(构建和测试)的相关性之间的权衡。任何会阻碍团队进展的代码都不应该进入主分支。

部署的持续交付是指尽可能全面地运行检查，以捕捉代码中的问题。检查的完整性是最重要的因素。它通常是根据测试的代码覆盖率或功能覆盖率来衡量的。尽早捕捉错误可以防止错误代码被部署到任何环境中，并节省测试团队的宝贵时间。

精心制作您的 CI 和 CD 版本，以实现这些目标并保持您的团队高效工作。没有一个工作流程是完美的。问题时不时会出现。每次它们发生时，把它们作为经验教训来加强你的工作流程。

发表于 2019 年 11 月 27 日的 [Fire CI 博客](https://fire.ci/blog/)。