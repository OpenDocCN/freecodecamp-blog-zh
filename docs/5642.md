# 我如何用 React 钩子用大约 100 行代码构建了一个异步表单验证库

> 原文：<https://www.freecodecamp.org/news/how-i-built-an-async-form-validation-library-in-100-lines-of-code-with-react-hooks-81dbff6c4a04/>

by Austin Malerba

# 我如何用 React 钩子用大约 100 行代码构建了一个异步表单验证库

![1*EGRMyNT8x7gb0LdLmj4xMQ](img/e7b5f393dd1b9c14a2f589348148e780.png)

表单验证可能是一件棘手的事情。当您深入到表单实现的内部时，会发现数量惊人的边缘情况。幸运的是，有许多表单验证库提供了必要的标志和处理程序来实现健壮的表单，但是我挑战自己，使用 [React Hooks API](https://reactjs.org/docs/hooks-reference.html) (目前在 alpha 中)用不到 100 行代码构建了一个表单验证库。因为 React 钩子仍然是一个实验性的提议，所以这是一个应用 React 钩子实现表单验证的概念证明。

另外，公平的警告，我构建的*库*有 100 行代码，但是本教程有大约 200 行代码，因为我需要展示如何使用这个库。

我看到的很多表单教程都没有解决三大主题:**异步验证**，当**其他** **字段改变**时应该触发的字段验证，以及**验证频率的优化**。我被专注于单个用例并保持所有其他变量不变的教程所困扰，因为这不是真实世界的工作方式，所以我将尝试各种用例。

让我们以满足以下条件为目标:

*   当字段值更改时，同步验证字段和任何相关字段
*   当字段值更改时，异步验证字段和任何相关字段
*   提交前同步验证所有字段
*   提交前异步验证所有字段
*   尝试异步提交，如果表单提交失败，显示响应中的错误
*   向开发人员公开验证方法，以便开发人员可以验证 onBlur 或在其他有意义的时候进行验证
*   允许每个字段进行多次验证
*   如果表单有错误，则禁用提交
*   不要显示字段的错误，除非它已被更改或已尝试提交表单

我们将通过实现一个包含用户名、密码和密码确认的帐户注册表单来讨论这些用例。下面我概述了我们正在寻找的接口类型，我们将建立一个库来满足这个合同。

这是一个相对简单的 API，但是应该给我们很多的灵活性。您可能已经注意到，这个接口包括两个名称相似的函数，validation 和 validate。我们将验证定义为一个函数，它接受表单数据和字段名，如果发现问题，它将返回一个错误消息，否则它将返回一个 falsey 值。另一方面，验证函数将运行字段的所有验证函数，并更新字段的错误列表。

首先，我们需要一个框架来处理值的变化和表单提交。我们的第一次迭代将不包括任何验证，它将仅仅处理表单状态。

这段代码中没有什么太疯狂的事情发生。我们跟踪的唯一状态是字段值。我们让每个字段在初始化结束时向表单注册自己。我们的 onChange 处理程序很简单。这里最吓人的函数是 getFormData，但在难看的 reduce 语法后面，这也是微不足道的。getFormData 遍历表单域，并为我们提供表单值的简单对象表示。我觉得我应该解释的最后一件事是，我们需要在提交时调用 preventDefault 来防止页面被重新加载。

这很好，但是现在让我们添加对验证的支持。我们还不会指定当字段值改变时应该验证哪些字段。相反，无论何时值发生变化，无论何时提交表单，我们都将验证所有字段。

上面的代码是一个改进，乍一看，它似乎可以很好地工作，但实际上它对最终用户来说是非常草率的。它缺少许多必要的标志，这些标志有助于防止错误在不适当的时候出现。它会在用户有机会修改字段之前立即对其进行验证，并显示相应的错误。

至少我们需要一个原始的标志来告诉 UI，如果用户没有更改字段，就不要显示错误。但是让我们更进一步。除了一个原始的旗帜，我们将需要更多的旗帜。

我们将需要一个标志来指示用户已经尝试提交表单，我们将需要标志来指示表单提交的时间和每个字段异步验证的时间。您可能还想知道为什么我们在 useEffect 内部调用 validateFields，而不是在 onChange 处理程序内部。我们需要 useEffect，因为 setValue 异步发生，既不返回承诺也不提供回调。因此，我们可以确定 setValue 已经完成的唯一方法是通过 useEffect 监听值的变化。

让我们实现我提到的标志来帮助清理 UI 和处理一些边缘情况。

我们的最终迭代增加了很多。它添加了四个标志:原始、验证、提交和提交。它还添加了 fieldsToValidateOnChange 参数，该参数被传递给 validateFields 以指示当字段值更改时应该验证哪些字段。我们在 UI 中使用这些标志来控制何时显示微调器和错误，以及禁用提交按钮。

您可能已经注意到的一件奇怪的事情是 validateCounter。我们需要跟踪 validate 函数被调用的次数，因为当我们的 validate 函数完成时，validate 函数可能会被再次调用。如果是这种情况，我们需要忽略这次调用的结果，只使用最近一次调用的结果来更新字段的错误状态。

当该说的都说了，该做的都做了，这就是功能性结果。

React 钩子为表单验证提供了一个简洁的解决方案。这是我第一次使用提议的 API 进行实验，我发现它很强大，但是有点笨拙。界面很奇特，对我来说有点太神奇了。然而，一旦我接受了它的缺点，它就证明了自己的能力。

我确实觉得它缺少一些功能，即一个回调机制来指示用户状态设置器何时完成状态更新，以及一种在 useEffect 钩子中检查属性增量的方法。

#### 便笺后

为了使本教程简明易懂，我有意省略了一些参数验证和错误处理。例如，我不检查传入字段的表单是否确实是表单。显式检查这一点并抛出一个详细的错误会好得多。然而，正如我所写的，代码会像这样爆炸

```
Cannot read property ‘addField’ of undefined
```

这段代码需要适当的参数验证和错误处理，然后才能作为 npm 库发布。也就是说，我已经实现了一个更加健壮的版本，如果你愿意的话，它包括了通过[超结构](https://github.com/ianstormtaylor/superstruct)的参数验证。