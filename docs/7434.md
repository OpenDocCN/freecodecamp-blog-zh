# 以太坊分散投票应用程序开发指南

> 原文：<https://www.freecodecamp.org/news/developing-an-ethereum-decentralized-voting-application-a99de24992d9/>

作者 Timothy Ko

# 以太坊分散投票应用程序开发指南

![1*cQl1eHoplkcQF2dTaWo5FA](img/11bb201168ab5c3e682491ab59770e97.png)

Photo by Andre Francois

在整个加密货币市场的市值超过 7000 亿美元后，加密货币领域在过去几个月里出现了爆炸式增长。但这仅仅是开始。随着区块链系统的不断发展和扩展，进入这一新领域并利用这一技术的一个很好的方法是使用分散式应用程序，也称为 dApps。

[CryptoKitties](https://www.cryptokitties.co/) ，因以太坊区块链的拥挤而闻名，是 dApp 的一个很好的例子，独特地将可繁殖和可收藏的猫的概念与区块链结合起来。这个轰动的游戏只是无数机会中的一个有创意的例子。

虽然看起来非常复杂，但是已经开发了某些框架和工具来抽象您与区块链和智能合约的交互。在这篇博文中，我将介绍一种在以太坊上创建去中心化投票应用的方法。我将简要介绍以太坊，但是你可能应该对它有所了解，以便最大限度地使用本指南。此外，我希望你了解 Javascript。

### 为什么要做去中心化投票 app？

本质上，一个利用区块链技术的强大的分散式应用程序允许您在没有可信第三方的情况下执行与现在相同的操作(比如转账)。最好的 dApps 有一个具体的真实世界用例，利用区块链的独特特征。

> 本质上，区块链是一个共享的、可编程的、密码安全的因而是可信的分类账，没有单个用户控制，任何人都可以检查。克劳斯·施瓦布

尽管投票应用程序对消费者来说可能不是一个很好的应用程序，但我还是选择在本指南中使用它，因为区块链解决的主要问题——透明度、安全性、可访问性、可听度——是困扰当前民主选举的主要问题。

由于区块链是分发的交易(投票)的永久记录，每一次投票都可以无可辩驳地追溯到发生的确切时间和地点，而不会暴露投票人的身份。此外，过去的投票不能改变，而现在的投票不能被黑客攻击，因为每一笔交易都要经过网络中每一个节点的验证。任何外部或内部攻击者必须控制 51%的节点才能改变记录。

即使攻击者能够做到这一点，同时在雷达下不正确地输入用户的真实 id 投票，端到端投票系统也可以允许投票者验证他们的投票是否正确地输入到系统中，从而使系统非常安全。

### 以太坊的核心组件

我希望你在本指南的剩余部分对[区块链](https://www.coindesk.com/information/what-is-blockchain-technology/)和[以太坊](https://www.ethereum.org/)有所了解。[这里](https://medium.com/@preethikasireddy/how-does-ethereum-work-anyway-22d1df506369)是一个关于它的很棒的指南，我写了一个我想让你知道的核心组件的简要概述。

1.  **智能合约**充当后端逻辑和存储。合同是用智能合同语言 [Solidity](http://solidity.readthedocs.io/en/develop/solidity-in-depth.html) 编写的，是驻留在以太坊区块链特定地址的代码和数据的集合。它非常类似于面向对象编程中的类，其中包括函数和状态变量。智能合约和区块链是所有去中心化应用的基础。它们像区块链一样，是不可变的和分布式的，这意味着如果它们已经在以太坊网络上，升级它们将是一种痛苦。幸运的是，[这里](https://consensys.github.io/smart-contract-best-practices/software_engineering/)有一些方法可以做到这一点。
2.  **以太坊虚拟机(EVM)** 处理整个以太坊网络的内部状态和计算。可以把 EVM 想象成一台巨大的分散式计算机，它包含能够执行代码、改变数据和相互交互的“地址”。
3.  [**Web3.js**](https://github.com/ethereum/wiki/wiki/JavaScript-API) 是一个 Javascript API，允许你与区块链进行交互，包括进行交易和调用智能合约。这个 API 抽象了与以太坊客户端的通信，允许开发人员专注于他们应用程序的内容。为此，您必须在浏览器中嵌入一个 web3 实例。

### 我们将使用的其他工具

1.  [**松露**](http://truffleframework.com/docs/) 是以太坊流行的测试开发框架。它包括开发区块链、编译和迁移脚本以将您的合同部署到区块链、合同测试等。它使开发更容易！
2.  [**Truffle Contracts**](https://github.com/trufflesuite/truffle-contract) 是 Web3 Javascript API 之上的一个抽象，让你可以轻松地连接和交互你的智能合约。
3.  [**Metamask**](https://metamask.io/) 为你的浏览器带来以太坊。它是一个浏览器扩展，提供一个安全的 web3 实例链接到你的以太坊地址，允许你使用分散的应用程序。我们不会在本教程中使用元蒙版，但它是人们在生产中与您的 DApp 进行交互的一种方式。相反，我们将在开发过程中注入我们自己的 web3 实例。更多信息，请查看[的这个](http://truffleframework.com/docs/advanced/truffle-with-metamask)链接。

### 开始吧！

为了简单起见，我们实际上不会构建我前面描述的完整的投票系统。为了便于解释，这只是一个单页的应用程序，用户可以输入他们的 ID 并为候选人投票。还将有一个按钮，计算和显示每个候选人的票数。

通过这种方式，我们将能够在应用程序中专注于创建智能合约并与之交互的过程。整个应用程序的源代码将在[这个存储库](https://github.com/tko22/eth-voting-dapp)中，您需要安装 Node.js 和 npm。

首先，让我们全球安装松露。

```
npm install -g truffle
```

要使用 Truffle 命令，您必须在现有项目中运行它们。

```
git clone https://github.com/tko22/truffle-webpack-boilerplatecd truffle-webpack-boilerplatenpm install
```

这个存储库只是 Truffle Box 的框架，它是样板文件或示例应用程序，您可以通过一个命令— `truffle unbox [box name]`获得。然而，带有 webpack 的 Truffle box 并没有更新为最新版本，并且包含了一个示例应用程序。因此，我创建了这个[回购](https://github.com/tko22/truffle-webpack-boilerplate)(上面说明中链接的那个)。

#### 2.目录结构

您的目录结构应该包括以下内容:

*   `contracts/` —保存所有合同的文件夹。**不删除** `Migrations.sol`
*   `migrations/` —保存[迁移文件](http://truffleframework.com/docs/getting_started/migrations)的文件夹，帮助你将智能合约部署到区块链中。
*   `src/` —保存应用程序的 HTML/CSS 和 Javascript 文件
*   `truffle.js` —松露配置文件
*   在你完成合同之前，你不会看到这个文件夹。这个文件夹包含构建工件，所以不要修改任何这些文件！Build artifacts 描述了你的合约的功能和架构，并为 Truffle Contracts 和 web3 提供了如何在区块链中与你的智能合约进行交互的信息。

### 1.撰写您的智能合同

设置和介绍到此为止。让我们进入代码！首先，我们将编写我们的智能合同，它是用 [Solidity](http://solidity.readthedocs.io/en/develop/index.html) 编写的(其他语言不太流行)。这可能看起来很可怕，但事实并非如此。

对于任何应用程序来说，你都希望你的智能合约尽可能简单，甚至简单到愚蠢。记住，你必须为你进行的每一次计算/交易付费，你的智能合约将永远在区块链**上。**所以，你真的希望它完美地工作——也就是说，它越复杂，就越容易出错。

我们的合同将包括:

1.  **状态变量** —保存永久存储在区块链上的值的变量。我们将使用状态变量来保存选民和候选人的列表和数量。
2.  [**函数**](http://solidity.readthedocs.io/en/develop/contracts.html#functions) —函数是智能合约的可执行文件。它们是我们所说的与区块链交互的东西，它们有不同程度的可见性，内部和外部。请记住，无论何时您想要更改变量的值/状态，都必须进行一次事务处理——否则会产生成本。你也可以对区块链进行`calls`，这不会花费任何以太网，因为你所做的更改将被销毁(在第 3 节我们实际进行`transactions`和`calls`时会有更多关于这方面的内容)。
3.  [**事件**](http://solidity.readthedocs.io/en/develop/contracts.html#events) —每当调用一个事件时，传递给该事件的值将被记录在事务的日志中。这允许 Javascript 回调函数或 resolved promises 查看您希望在事务后传回的特定值。这是因为每次进行交易时，都会返回一个交易日志。我们将使用一个事件来记录新创建的候选人的 ID，我们将显示它(检查第 3 节的第一个要点)。
4.  [**结构类型**](http://solidity.readthedocs.io/en/develop/types.html#structs) —这与 C 结构非常相似。结构允许你保存多个变量，对于有多个属性的东西来说是很棒的。只会有他们的名字和队伍，但是你绝对可以给他们添加更多的属性。
5.  **映射** —把这些想象成哈希映射或字典，其中有一个键值对。我们将使用两种映射。

还有几个类型没有在这里列出，但是其中一些稍微复杂一些。这五个包含了智能合同通常使用的许多结构。这些类型在这里有更深入的解释[。](http://solidity.readthedocs.io/en/develop/structure-of-a-contract.html#)

作为参考，下面是智能合约的代码。注意，这个文件应该叫做`Voting.sol`，但是我想让 Github gist 具有样式，所以我给了它一个`.js`扩展名。像本指南的其余部分一样，我将在代码中提供注释，解释它在做什么，之后我将解释大图，同时指出某些警告和逻辑。

基本上，我们有两个结构(保存多个变量的类型)来描述投票者和候选人。有了结构，我们就能够给它们分配多个属性，比如电子邮件、地址等等。

为了跟踪投票者和候选人，我们将他们放入单独的映射中，并对他们进行整数索引。**候选人或投票人的索引/密钥——姑且称之为 ID——是函数访问它们的唯一方式**。

我们还跟踪选民和候选人的数量，这将有助于我们对他们进行索引。此外，不要忘了第 8 行中的事件，它将在添加时记录候选人的 ID。我们的接口将使用这个事件，因为我们需要跟踪候选人的 ID，以便为候选人投票。

1.  我知道，与我之前说的让合同变得超级简单相反，我把这个合同变得比这个应用程序实际做的要复杂一点。然而，我这样做是为了让你们以后更容易编辑和添加特性到这个应用程序中。如果你想做一个更简单的投票应用程序，智能合同可以在不到 15 行代码内完成。
2.  注意，状态变量`numCandidates`和`numVoters`没有被声明为公共的。通过[默认](http://solidity.readthedocs.io/en/develop/contracts.html#visibility-and-getters)，这些变量具有`internal`的可见性，这意味着它们只能被当前契约或派生契约直接访问(不要担心，我们不会使用它)。
3.  我们使用`32bytes`来表示字符串，而不是使用`string`类型。我们的 [EVM 有一个 32 字节的字长](https://ethereum.stackexchange.com/q/2327/42)，所以它是为处理 32 字节的数据块而“优化”的。(当数据不是 32 字节的块时，编译器，如 Solidity，必须做更多的工作并生成更多的字节码，这实际上导致了更高的 gas 成本。)
4.  当用户投票时，一个新的`Voter`结构被创建并添加到映射中。为了计算某个候选人的票数，您必须遍历所有投票人并计算投票数。考生操作行为相同。因此，这些映射将保存所有候选人和投票人的历史。

### 2.实例化 web3 和合同

智能合约完成后，我们现在需要运行我们的测试区块链，并将该合约部署到区块链上。我们还需要一种与它对话的方式，那就是通过 web3.js。

在我们开始测试区块链之前，我们必须在文件夹`/contracts`中创建一个名为`2_deploy_contracts.js`的文件，告诉它在迁移时包含您的投票智能契约。

要开始开发以太坊区块链，请进入命令行并运行:

```
truffle develop
```

这将存在于您的命令行中。由于 Solidity 是一种编译语言，我们必须首先将其编译成字节码，以便 EVM 执行。

```
compile
```

现在，您应该会在目录中看到一个`build/`文件夹。这个文件夹保存了构建工件，这些工件对 Truffle 的内部工作至关重要，所以不要碰它们！

接下来，我们必须迁移合同。 [Migrations](http://truffleframework.com/docs/getting_started/migrations) 是一个 Truffle 脚本，可以帮助你在开发过程中改变应用程序的契约状态。记住你的合同是部署到区块链上的某个地址，所以无论何时你做了更改，你的合同都会位于不同的地址。迁移可以帮助您做到这一点，还可以帮助您移动数据。

```
migrate
```

恭喜你！你的智能合约现在永远在区块链上了。嗯，不完全是…因为`truffle develop`每次停止都会刷新。

如果你想有一个持久的区块链，考虑[加纳切](http://truffleframework.com/ganache/)，这也是由松露开发的。如果使用的是 Ganache，就不需要调用`truffle develop`。相反，你将跑`truffle compile`和`truffle migrate`。要了解部署没有松露的合同到底需要什么，请查看这篇[博客文章](https://medium.com/@gus_tavo_guim/deploying-a-smart-contract-the-hard-way-8aae778d4f2a)。

一旦我们将智能合约部署到区块链，无论何时应用程序启动，我们都必须在浏览器上用 Javascript 设置一个 web3.0 实例。因此，下一段代码将被放在`js/app.js`的底部。注意，我们使用的是 web3.0 版本 0.20.1。

如果你不理解这些代码，你真的不用太担心。只需知道这将在应用程序启动时运行，并检查您的浏览器中是否已经有一个 web3 实例(Metamask)。如果没有，我们就创建一个与`localhost:9545`对话的，也就是松露开发区块链。

如果您使用的是 Ganache，则必须将端口更改为`7545`。一旦创建了实例，我们将调用`start`函数(我将在下一节中定义它)。

### 3.添加功能

我们需要做的最后一件事是为应用程序编写接口。这涉及到任何 web 应用程序的基本要素 HTML、CSS 和 Javascript(我们已经在创建 web3 实例时编写了一点 Javascript)。首先，让我们创建我们的 HTML 文件。

这是一个非常简单的页面，有一个用户 ID 的输入表单，以及投票和计票的按钮。当这些按钮被点击时，它们将调用投票的特定函数，并将找到候选人的票数。

不过有三个重要的 div 元素，id 分别为:`candidate-box`、`msg`和`vote-box`，它们分别包含每个候选人的复选框、一条消息和投票数。我们还导入 JQuery、Bootstrap 和`app.js`。

现在，我们只需要与契约进行交互，并实现投票和统计每个候选人票数的功能。JQuery 将操纵 DOM，当我们进行交易或调用区块链时，我们将使用承诺。下面是`app.js`的代码。

请注意，我在上一步中提供的用于创建 web3 实例的代码也在这里。首先，我们导入必要的库和 webpack，包括 web3 和[松露契约](https://github.com/trufflesuite/truffle-contract)。我们将使用 Truffle Contracts，它建立在 web3 之上，用于与区块链进行交互。

为了使用它，我们将获取编译投票智能契约时自动构建的构建工件，并使用它们来创建 Truffle 契约。最后，我们在全局变量`window`中设置了用于启动应用程序、为候选人投票以及计算投票数的函数。

为了与区块链进行实际交互，我们必须使用`deployed`函数创建块菌契约的一个实例。反过来，这将返回一个带有实例的承诺作为返回值，您将使用该实例从智能协定中调用函数。

有两种方式与这些功能交互:事务和调用。一个事务是一个写操作，它将被广播到整个网络并由矿工处理(因此，开销也很大)。如果您正在更改状态变量，您必须执行一个事务，因为它将更改区块链的状态。

一个调用是一个读操作，模拟一个事务，但是放弃状态的改变。因此，它不会花费乙醚。这对于调用 getter 函数非常有用(查看我们之前在智能契约中编写的四个 getter 函数)。

要用松露合同进行交易，您需要编写`instance.functionName(param1, param2)`，用`instance`作为由`deployed`函数返回的实例(查看第 36 行的例子)。该事务将返回一个承诺，以事务数据作为返回值。因此，如果您在智能合约函数中返回值，但您使用相同的函数执行交易，它将不会返回值。

这就是为什么我们有一个事件，它将记录您希望它写入将被返回的事务数据中的任何内容。在第 36–37 行的情况下，我们进行一个事务来添加一个候选人。当我们解析承诺时，我们在`result`中有交易数据。

为了获取我们记录的事件`AddedCandidate()`的`candidateID`(检查智能契约以查看它是否为 0)，我们必须浏览日志并像这样检索它:`result.logs[0].args.candidateID`。

要真正了解发生了什么，使用 Chrome 开发工具打印出`result`并查看其结构`result`。

要打电话，你会写`instance.functionName.call(param1,param2)`。然而，如果一个函数有关键字`view`，那么 Truffle 契约将自动创建一个调用，因此你不需要添加`.call`。

这就是为什么我们的 getter 函数有`view`关键字。与进行交易不同，调用的返回承诺将具有智能合约函数返回的任何值。

我现在将简要解释这 3 个函数，但是如果您已经构建了从数据存储中检索/更改数据并相应地操作 DOM 的应用程序，那么这应该非常熟悉。把区块链想象成你的数据库，松露合约就是从你的数据库获取数据的 API。

#### **App.start()**

在我们创建一个 web3 实例后，这个函数会立即被调用。为了让 Truffle 合同生效，我们必须将提供者设置为创建的 web3 实例，并设置默认值(比如您正在使用哪个帐户以及您想要支付多少汽油来进行交易)。

由于我们处于开发模式，我们可以使用任何数量的气体和任何帐户。在生产过程中，我们会使用 MetaMask 提供的帐户，并尝试计算出您可以使用的最小气体量，因为这实际上是真金白银。

设置好一切后，我们现在将显示每个候选人的复选框，供用户投票。为此，我们必须创建一个契约实例，并获取候选人的信息。如果没有候选人，我们将创建他们。为了让用户为候选人投票，我们必须提供特定候选人的 ID。因此，我们让每个 checkbox 元素都有一个候选人 ID 的`id` (HTML 元素属性)。此外，我们将把候选人的数量添加到一个全局变量`numOfCandidates`，我们将在`App.findNumOfVotes()`中使用这个变量。JQuery 用于将每个复选框及其候选名称追加到`.candidate-box`。

#### **App.vote()**

该功能将根据被点击的复选框及其`id`属性为某个候选人投票。

第一，我们会检查用户是否输入了他们的用户名，这是他们的身份证明。如果他们没有，我们会显示一条消息告诉他们这样做。

第二，我们将检查用户是否为候选人投票，检查是否至少有一个复选框被点击。如果没有选中任何复选框，我们还会显示一条消息，告诉他们为候选人投票。如果单击其中一个复选框，我们将获取该复选框的`id`属性，这也是链接的候选人的 ID，并使用它为候选人投票。

交易完成后，我们将解析返回的承诺并显示“已投票”消息。

#### **App.findNumOfVotes()**

最后一个函数将找到每个候选人的票数并显示出来。我们将检查候选对象，并调用两个智能合约函数，`getCandidate`和`totalVotes`。我们将解决这些承诺，并为特定的候选人创建一个 HTML 元素。

现在，启动应用程序，您将在`http://localhost:8080/`上看到它！

```
npm run dev
```

### 资源

我知道，这是很多…当你慢慢开发这个应用程序并真正理解发生了什么时，你可能会打开这篇文章一段时间。但那是学习！请用以太坊、松露和我下面提供的所有文档来补充这个指南。我试图触及本文中的许多关键点，但这只是一个简要的概述，这些资源会有很大帮助。

*   关于可靠性和智能合约的一切——我指的是一切
*   [**关于松露的一切**](http://truffleframework.com/docs/)
*   [**松露合同单据**](https://github.com/trufflesuite/truffle-contract)
*   [**web 3 Javascript API**](https://github.com/ethereum/wiki/wiki/JavaScript-API)**——了解和参考这一点很好，但是块菌契约抽象了其中的许多部分**
*   **[**有用的 DApp 图案**](https://github.com/ethereum/wiki/wiki/Useful-%C3%90app-Patterns)**
*   **[](https://github.com/ethereum/wiki/wiki/Ethereum-introduction)**——看看边栏，里面有很多东西****
*   ****[**密码猫代码解释**](https://medium.com/loom-network/how-to-code-your-own-cryptokitties-style-game-on-ethereum-7c8ac86a4eb3) —笔者梳理了密码猫智能合约的重要部分****
*   ****[**智能合同最佳实践**](https://consensys.github.io/smart-contract-best-practices/) —必读****

### ****结论****

****在以太坊上构建应用程序与普通应用程序调用后端服务非常相似。最难的部分是写一个健壮和完整的智能合同。我希望这篇指南能帮助你理解去中心化应用和以太坊的核心知识，并帮助你激发开发它们的兴趣。****

****如果你想在我们已经建立的基础上再接再厉，这里有一些想法。实际上，我已经以这样一种方式编写了智能合同，它很容易用我在本指南中给你的所有内容来实现。****

*   ******显示每个候选人的党派。**当我们运行`getCandidate(id)`时，我们已经得到了候选人的政党。****
*   ******检查用户输入的 ID 是否唯一。******
*   ******询问并存储用户的更多信息，**例如他们的出生日期和家庭住址。****
*   ****添加一个选项，查看具有特定 id 的人是否已经投票。您将创建一个新的表单来输入一个 ID，然后您将在区块链搜索该特定用户。****
*   ****编写一个新的智能合约函数，可以同时计算两个候选人的票数。目前，我们必须为两个候选人发出两个单独的调用，这要求契约在所有用户中循环两次。****
*   ******允许添加新候选人。**这意味着添加一个新的表单来添加候选人，但也改变了一点我们如何在前端显示和投票给候选人。****
*   ******要求用户拥有以太坊地址才能投票。**我不包括用户地址的逻辑是因为投票人不希望以太坊参与投票过程。然而，许多 DApps 会要求用户有一个以太坊地址。****

****此外，这里有一些提示可以防止一些障碍的发生:****

*   ****当奇怪的事情发生时，反复检查你的智能合同功能。我花了几个小时解决一个 bug，发现我在一个函数中返回了错误的值。****
*   ****当您连接到您的开发区块链时，检查您的 URL 和端口是否正确。记住:`7545`代表`truffle develop`，`9545`代表加纳切。这些是**默认值，**所以如果你不能连接到你的区块链，你可能已经改变了它们。****
*   ****我没有看这个，因为这个指南太长了，我可能会再发一个帖子——但是你应该[测试一下你的合同！会有很大帮助。](http://truffleframework.com/docs/getting_started/testing)****
*   ****如果你对[承诺](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise)不熟悉，那就浏览一下它们是如何运作以及如何使用的。Truffle Contracts 使用承诺，web3 的测试版也将支持承诺。如果你做错了，它们会弄乱你正在检索的大量数据。****

****为致力于去中心化和安全的互联网——Web 3.0 干杯！****

****我希望你喜欢阅读本指南，就像我喜欢写它一样！如果你有任何想法和评论，欢迎在下面留下你的评论，或者给我发电子邮件到 tk2@illinois.edu 或者发推特到 T2(我最近创建了一个)！请随意使用我的代码，并与您的朋友分享！****