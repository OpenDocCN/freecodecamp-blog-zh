# 跨站点请求伪造-什么是 CSRF 攻击以及如何防范

> 原文：<https://www.freecodecamp.org/news/what-is-cross-site-request-forgery/>

当用户通过身份验证后，恶意站点或程序导致用户的浏览器在受信任的站点上执行不必要的操作时，就会发生跨站点请求伪造或 CSRF。任何恶意操作都仅限于用户通过身份验证的网站的能力。

例如，Jane 可能在查看电子邮件时登录到她的在线银行门户。在那里，她可能会单击网络钓鱼电子邮件中的链接(很可能被链接缩短网站混淆)，其中包括请求 Jane 的银行将资金转移到攻击者控制的帐户。

因为 Jane 已经通过了银行的身份验证，所以他们自动执行交易，因为 Jane 的浏览器正在请求交易，所以他们认为 Jane 已经授权了交易。

## 什么是 HTTP 请求和 Cookies？

### HTTP GET 请求

这是一个用于从 web 服务器请求数据的请求(例如键入 URL(请求一个网站),这会导致加载)。

### HTTP POST 请求

这是用于向 web 服务器发送数据的请求(例如，web 表单提交)。

有些 GET 和 POST 请求是自动触发的，无需用户交互(比如获取搜索建议或加载带有 img src 属性的图像内容)。

### 会话 cookie

会话 cookies 是 HTTP 处理状态的一种方式(因为它本身不处理状态)。网站使用会话 cookies(包含唯一的 ID)来识别用户并保留他们的会话。

设置完成后，用户的浏览器在每次请求时都会将 cookie 发送给服务器，以便在站点上识别用户。

攻击者可以利用 cookie 通过强制用户的浏览器执行请求来模拟用户。如果用户已经登录到该站点，cookie 将随请求自动发送。

## 跨站点请求伪造是如何工作的？

为了让攻击者实施 CSRF 攻击，需要满足几个条件:

*   应用程序中有一个攻击者想要执行的操作，比如更改密码、转移资金等等。
*   没有不可预测的请求参数——攻击者可以猜测(或知道)应用程序希望从这种类型的请求中看到的所有参数。
*   该操作可以通过 HTTP 请求来执行，并且它仅依赖于 cookies 来验证请求是否来自用户。

CSRF 会影响使用 cookies、浏览器身份验证或客户端证书来验证用户身份的 web 应用程序。本质上，它可以发生在应用程序自动将用户的凭证或身份附加到请求的任何情况下。

CSRF 攻击可以利用 GET 请求或 POST 请求(尽管 POST 请求更复杂，因此不常见)。

任何一种都需要从攻击者诱骗受害者将信息加载或提交到 web 应用程序开始。这可以通过多种方式发生，例如通过网络钓鱼链接。

或者，类似于 XSS(跨站点脚本)，CSRF 可以是一个存储的漏洞。当攻击者将攻击存储在接受 HTML 的字段(如 IMG 或 IFRAME 标签)中时，就会发生存储 CSRF。这意味着任何查看该页面的人都可能受到影响。该漏洞可以伪装成普通链接或隐藏在图像标签中。

比如作为网页上的普通链接:`<a href=“malicious link”>Unsubscribe here</a>`

或者，作为图像标签:`<img src=“malicious link” width=“0” height=“0” border=“0”>`

## CSRF 的例子

假设您的银行(bank.com)使用 GET 请求处理转账，该请求包含几个参数(转账收款人的身份和您想要转账的金额)。

例如，如果 Jim 想给他的朋友 Bob $10，请求可能是这样的:

`http://bank.com/transfer?recipient=Bob&amount=10`

该请求还包括一个会话 cookie，用于识别帐户所有者，这样银行就知道从哪里取钱。

现在，攻击者可能会说服 Jim 点击一个如下所示的链接(但已被 URL 缩短器缩短或巧妙地超链接):

`http://bank.com/transfer?recipient=Hacker&amount=100000`

因为 Jim 已经登录，他的浏览器发送了带有请求的 cookie，所以他的银行认为他在请求转账，并执行了转账。

## 如何阻止 CSRF 袭击

### 仔细选择你的框架

使用内置了 CSRF 防护的框架，比如. NET。正确的配置是关键。如果您使用的框架没有保护，您可以使用反 CSRF 令牌来添加保护。

### 使用反 CSRF 代币

令牌(也称为同步令牌模式)是一种服务器端保护，其中服务器为用户的浏览器提供一个唯一的、随机生成的令牌，并在执行请求之前检查每个请求以查看浏览器是否将其发送回来。

该令牌通过隐藏字段发送，并且应该是一个不可预测的随机数，该随机数在短时间后过期，并且不能被重用。

根据页面的敏感性，可以为每个请求使用不同的令牌，或者简单地为不同的表单使用不同的令牌。令牌应该以安全的方式进行比较(例如通过比较哈希)，并且不应该在 HTTP get 请求中发送，这样它们就不是 URL 的一部分，也不会通过 Referrer 头泄漏。

### 在 Cookies 中使用 SameSite 标志

SameSite 标志标记了一个 cookie，因此它只能被发送给来自同一个域的请求。

基本上，如果 www.bank.com 想向`www.bank.com/updatepassword`提出请求，它是被允许的。但是如果`www.maliciousdomain.com`想要向 www.bank.com/updatepassword,发出请求，它就不能发送会话 cookie，因此就不能实施攻击。

大多数浏览器现在支持这个标志，但不是所有的。它应该是综合防御战略的一部分。

### 练习纵深防守

您可以实施许多其他控制措施，当这些措施与其他措施结合使用时，可以提供针对 CSRF 的保护。

例如，以下是您可以采取的一些其他保护措施:

*   使用标准头验证来源(确定请求的来源和目标，以确保它们匹配)
*   使用自定义请求标题(这样，如果没有标题，站点将不会接受请求)
*   双重提交 cookies(实际上是第二个随机生成的、攻击者未知的参数，攻击者必须随请求提交该参数才能成功)。

### 让用户参与交易

对于敏感操作，如资金转账或密码更改，要求用户采取措施(如验证码、一次性令牌或重新认证)。

## 不起作用的措施示例:

*   **多步交易:**只要攻击者能够预测/确定每一步，有多少步并不重要。
*   HTTPS: 这是个好主意，但并不能抵御 CSRF。
*   **URL 重写:**这将防止攻击者在 CSRF 攻击中猜测受害者的会话 ID，但会允许攻击者在 URL 中看到它。用一个缺陷替换另一个缺陷不是一个好主意。
*   **使用秘密 Cookie:** 即使是秘密 Cookie 也会作为请求的一部分提交，这意味着攻击者仍然可以利用它。
*   **仅接受 POST 请求/避免 GET 请求:**伪造的 POST 请求仍可用于执行 CSRF 攻击。

### CSRF 的其他名字

CSRF 也被称为 XSRF，海上冲浪，会话骑，跨网站参考伪造，敌意链接，一键攻击。

### 来源/延伸阅读:

*   奥瓦斯普 CSRF
*   [OWASP CSRF 预防](https://owasp.org/www-community/attacks/csrf)
*   [CSRF 袭击事件](https://www.netsparker.com/blog/web-security/csrf-cross-site-request-forgery/)
*   [反 CSRF 代币](https://www.netsparker.com/blog/web-security/protecting-website-using-anti-csrf-token/)
*   [CSRF 基础知识](https://www.acunetix.com/websitesecurity/csrf-attacks/)
*   [端口查看器 CSRF](https://portswigger.net/web-security/csrf)