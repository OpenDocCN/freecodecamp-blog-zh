# 如何构建代码库:多库、单库还是有机库？

> 原文：<https://www.freecodecamp.org/news/how-to-structure-code-repositories-multi-mono-or-organic-eda67b397d38/>

作者切坦·夏尔马

# 如何构建代码库:多库、单库还是有机库？

![BldvbE37nusd26cWWR6cj4LWA5HMBTFqXp7S](img/9d27d7e6b40108deaaefaa8d13c959a8.png)

Photo by [Joren](https://unsplash.com/photos/xXfBW9S3faU?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) on [Unsplash](https://unsplash.com/search/photos/monolithic?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

最新的争论是，您应该将您的服务保存在一个单一的存储库中还是多个小型存储库中。

多个小型存储库的想法是，应用程序的每个微服务的代码都保存在自己的存储库中。使用 mono-repo，您可以将所有代码保存在一个存储库中，并将代码部署为微服务。

那么应该用哪个呢？对任何一种方法过于执着——不考虑每种方法的目的和用途——从长远来看会导致负面结果。如果你知道何时使用每一个，它可以提高你的生产力和改善你的项目。

### 为了改变规则，我们需要首先理解它们为什么存在。

一个常见的建议是为每个应用程序/服务建立一个独立的存储库。但是为什么呢？因为，通过为每个微服务拥有一个存储库，我们获得了:

*   独立于所有其他服务以不同方式编写代码的自由。
*   **速度**在修正错误、进行更新、测试和部署的同时进行代码更改。由于只需在单个存储库中测试变更，因此代码的部署会更快、更可靠。
*   **将代码**分离为独立的单元，这可以防止服务之间的 bug 泄漏和性能瓶颈。
*   **明确每个存储库和服务的所有权**，这对大型团队特别有帮助。

### 但为什么会出现对单一回购的需求呢？

显然，多重回购方式有其好处。但是它也有自己的挑战，特别是在有大量使用相同框架、语言、技术栈等的微服务的项目中。

这些挑战包括:

*   **在所有存储库中实施标准和最佳实践**。对于多重回购，代码标准和最佳实践中的变化需要跨存储库进行复制。有了单一回购，所有的变化都可以在一个地方完成。
*   **维护共享或公共组件**的工作。安全补丁、版本升级和 bug 修复涉及到确保这些更改在所有存储库之间进行，并且它们在任何地方都无缝地工作。(另一方面，每个服务中的重复代码也增加了其规模。)在 mono-repo 中，我们可以在一个地方进行更新，既省时又省事。
*   **端到端测试**与开发者机器上密切相关或依赖的服务协同进行。通过将所有代码放在一个地方，我们简化了启动所有相关服务和运行端到端测试的过程。
*   其他业务代码的本地部署。通过将 mono-repo 部署为微服务，我们节省了时间，并减少了引导每个存储库的冗余工作。

显然，这两种方法都有优点和缺点，并且每种方法在不同的情况下都有自己的优点。

因此，我们采取了保持灵活性的方法，同时使用多重回购和单一回购，但只有在完全理解为什么我们选择为每种服务使用每种回购之后。这导致我们拥有多个包含多个微服务的 repos，以某种方式进行隔离，从而实现了:

*   维护和更新既简单又快速。
*   定位要调试或更改的代码更加结构化。
*   让新队友更容易入职。

### 我们如何决定使用什么类型的存储库

以下考虑因素帮助我们决定何时使用单一回购，何时使用多重回购。

#### 1.考虑将作为服务基础的代码。

> 从识别代码、维护和更新中的任何相似之处开始。如果多个存储库有相同的代码，最好把它们放在一个存储库中。

在一个服务中独立地编写不同代码的自由是多个小型存储库的好处之一。但是如果服务使用相同的语言、框架、日志、引导脚本、中间件等，它们通常会有很多相同的架构。重用这些共享的脚手架节省了时间。

例如，[Collect](http://socialcops.com/collect)——我们的主要数据收集工具——有多个构建在相同框架上的微服务。这些服务建立在 [Node.js](https://nodejs.org/en/) 、 [Express](https://expressjs.com/) 和[解析服务器](https://parseplatform.org/)之上。他们共享很多库，比如 [Winston](https://github.com/winstonjs/winston) 、[mongose](https://mongoosejs.com/)和其他第三方集成。以前，当这些服务都有自己的存储库时，更新或修复这些共享模块中的错误意味着分别更新和测试每个存储库。这既慢又麻烦。

然而，当我们将它们放在一个 mono-repo 中时，测试和更新共享模块变得更加容易和快速。应用安全补丁和实施标准变得更加容易，因为开发人员可以一次性完成所有的更改。

单一回购的潜在风险是，开发人员可以重用最初为无关模块编写的代码。当两个模块共享代码时，这种公共代码的变化会导致错误。如果这些错误没有得到检查，它们会影响不相关的微服务的 CI/CD(持续集成和交付)管道。为了避免这样的问题，拥有一个强大的测试套件是非常重要的。

#### 2.检查你是否有任何与其他模块非常不同的模块。

> 你正在开发一个需要完全不同的技术、语言、框架或持久性的模块吗？那么将它分离到一个单独的存储库中会更好。

在 Collect 中，有一些服务可以批量处理事件。它们维护队列，执行自定义脚本，并具有完全不同的错误处理机制。这些服务是用 Python 编写的，它们经常需要执行 CPU 密集型任务。

因此，当我们考虑重新构建 Collect 的代码时，将这些服务保存在一个单独的 repo 中是不言而喻的。这些服务与 Collect 的主存储库(如上所述)非常不同。虽然主存储库是面向用户的请求，但这个存储库完全是关于后台任务和执行的。此外，这些服务中的变更管理将是不同的，并且与主存储库相隔离。

考虑到代码维护以及它将如何随时间发展，我们将这些服务放在一个单独的存储库中。通过这样做，我们能够建立一个完全不同的变更管理系统，这被证明是非常有用和更有成效的。

#### 3.考虑不确定性，以及服务可能经历的变化频率。

当您开始从事高度不确定的工作时(无论是就问题的范围还是实现本身而言)，拥有一个不同的存储库可以为您提供测试所需的速度和自由度。

例如，假设您想要测试一种处理图像以识别对象的新方法。你想涉足机器学习，但你仍然不确定它将如何发展，或者问题陈述是否会发生巨大变化。在这种情况下，拥有一个单独的存储库，然后达到一个确定点，显然会更好。相反，如果您认为 API 已经达到了稳定性，并将在很长一段时间内保持不变，那么您可以调用将它与您的一个主存储库合并。

该博客最初发表在[blog.socialcops.com。](https://blog.socialcops.com/)以上是我们处理存储库决策的方式。我希望它能帮助你从基本原则出发思考这个问题。请[订阅](https://share.hsforms.com/1Ag85PQHyTgCzyx00Col3Sw1d0o3)我们的时事通讯，了解来自 [SocialCops](http://www.socialcops.com) 工程和数据科学团队的更多更新。