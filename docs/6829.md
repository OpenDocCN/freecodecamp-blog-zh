# 据专家称，这些是最有效的微服务测试策略

> 原文：<https://www.freecodecamp.org/news/these-are-the-most-effective-microservice-testing-strategies-according-to-the-experts-6fb584f2edde/>

杰克·卢梅塔

# 据专家称，这些是最有效的微服务测试策略

![sbKYk9o8a9Bes7H2j8bzO0-DtZvoyQ7ajq9a](img/dc6a3f6f46a3701a15cda3df6ae4f9c2.png)

Photo by [Riccardo Annandale](https://unsplash.com/@pavement_special?utm_source=medium&utm_medium=referral) on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral)

测试微服务很难。更具体地说，端到端测试很难，这是我们将在本文中更详细讨论的内容。

但首先，一个简短的故事。

当我第一次进入一个有七个独立微服务的技术堆栈时，我就知道了微服务测试有多难。每一个都有自己的代码库、依赖管理、特性分支和数据库模式——恰好也有一组独特的迁移。

说到忙乱。

我们采取的方法是在本地运行一切。这意味着，在任何给定的时间点，当我想要运行端到端测试时，我需要为七个微服务中的每一个执行以下五个步骤:

1.  确保我在正确的代码分支上(master 或者 feature_xyz)
2.  拉下那个分支的最新代码
3.  确保所有依赖项都是最新的
4.  运行任何新的数据库迁移
5.  启动服务

这只是运行测试的基本要求。很多时候，我会忘记为服务执行这些步骤中的一个，并花费 10-15 分钟来调试问题。一旦我最终让所有的服务都正常运行，我就可以开始测试套件了。这一经历确实让我怀念测试一个大石块的日子。

所以，是的，我发现端到端微服务测试很难——而且随着您引入的每项新服务，难度会成倍增加。但是不要害怕，因为有办法让测试微服务变得更容易。我和几位首席技术官谈过他们如何想出自己的创造性方法来解决这个复杂的问题。

### 常见的微服务测试方法

#### 单元测试

根据定义，微服务可能会更小，但是通过单元测试，您可以进行更细粒度的测试。单元测试关注于可测试软件的最小部分，以确定该组件是否按预期工作。著名的软件工程师、作家和国际演说家 Martin Fowler [将单元测试分为两类:](https://martinfowler.com/articles/microservice-testing/#testing-unit-introduction)

1.  **社交单元测试:**这种单元测试方法通过观察模块状态的变化来测试模块的行为。
2.  **独立单元测试:**这种方法关注的是一个对象和它的依赖之间的交互和协作，由测试替身来代替。

虽然这些单元测试策略是不同的，但 Fowler 提出它们并不相互竞争——它们可以协同使用来解决不同的测试问题。

在与 Pantheon 的 with David Strauss 的一次讨论中，David 告诉我“机会在于微服务非常简单，可以在其上进行单元测试。”

#### 集成测试

使用集成测试，您正在做听起来像在做的事情:测试组件之间的通信路径和交互以检测问题。根据 Fowler 的说法，集成测试“通过子系统练习通信路径，检查每个模块关于如何与它的同伴交互的任何不正确的假设。”

集成测试通常测试微服务和外部服务之间的交互，就像另一个微服务或数据存储一样。

Pusher 的平台负责人 Pawel Ledwon 告诉我，他的团队“倾向于集成测试。单元测试对于某些抽象仍然有用，但是对于面向用户的功能，它们很难模仿或跳过系统的重要部分。”

并不是每个和我交谈过的人都喜欢这个过程。例如，Mosquera 关于集成测试的观点非常值得一提:

> 就工时而言，集成测试很容易出错，而且成本很高。投资回报根本不存在。每个单独的集成测试都带来了用例的小范围覆盖。

#### 端到端测试

最后但同样重要的是端到端测试，如前所述，这可能是一项艰巨的任务。这是因为它涉及测试微服务的每个移动部分，确保它可以实现您构建它的目标。

福勒写了以下文字:

> 端到端测试可能还必须考虑系统中的异步，无论是在 GUI 中还是由于服务之间的异步后端流程。

他继续解释这些因素是如何导致“测试套件的剥落、过长的测试运行时间和额外的维护成本的。”

谈到端到端测试，我能给出的最好建议是限制每个服务尝试的次数。提到的其他微服务测试策略之间的健康平衡——比如单元测试和集成测试——将帮助您剔除较小的问题。

从定义上来说，端到端测试更大，需要更多的时间，并且更容易出错。为了保持低成本和避免时间浪费，当所有其他测试手段都用尽时，坚持端到端测试，并作为质量保证的最后一步。

### 测试微服务的挑战

微服务(与整体服务相比)需要额外的步骤，比如管理多个存储库和分支，每个存储库和分支都有自己的数据库模式。但是挑战可能比这更深。

以下是一些与测试微服务相关的关键挑战:

*   **可用性:**由于不同的团队可能管理他们自己的微服务，确保微服务的可用性(或者，更糟糕的是，试图找到一个所有微服务同时可用的时间)是很困难的。
*   **碎片化和整体化测试:**微服务被构建为单独工作，以及与其他松散耦合的服务一起工作。这意味着开发人员需要单独测试每个组件，以及一起测试所有组件。
*   **知识差距:**特别是对于集成测试(我们将在本文后面讨论)，无论是谁进行测试，都需要对每个服务有很好的理解，以便有效地编写测试用例。

据 Elastic 的 Swiftype SRE 负责人 Oleksiy Kovyrin 说，

> 在使用微服务时，我们必须牢记的一个重要问题是 API 稳定性和 API 版本控制。为了避免中断依赖于服务的应用程序，我们需要确保我们有一套针对微服务 API 的可靠集成测试，如果发生重大更改，我们必须为客户提供向后兼容的方式，以便他们按照自己的节奏迁移到新版本，从而避免大型跨服务 API 更改部署。

Sumo Logic 的首席架构师 Stefan Zier 也向我重申，微服务测试确实“非常非常困难”。

“尤其是当您走向更持续的部署时。“我们已经并将继续在集成测试、单元测试方面投入大量资金，如果我们有足够的人手来做，我们会做得更多，”齐尔告诉我。

话虽如此，他承认，在某些阶段，当 Sumo Logic 想要全面测试他们的服务时，“在某种意义上，整个公司或多或少[成为]一个质量保证团队。”

### 解决方案:创业公司的五种微服务测试策略

是的，测试微服务可能很困难，但是[考虑到微服务](https://buttercms.com/books/microservices-for-startups/should-you-always-start-with-a-monolith)的所有优势，因为测试挑战而放弃它们不是正确的途径。为了应对这些挑战，我从几位首席技术官那里获得了洞察力，并提炼出了他们用来成功测试微服务的五个策略。

#### 1.文档优先策略

工程 Sparkpost 副总裁克里斯·麦克法登在我们的讨论中很好地总结了文档优先战略:

> 我们遵循文档优先的方法，所以我们所有的文档都在 GitHub 的 markdown 中。我们的 API 文档是开源的，所以都是公开的。然后，我们要做的是，在任何人编写任何 API 更改或新 API 或 API 更改之前，他们将首先更新文档，审查该更改，以确保它符合我们的 API 约定和标准，这些都是有文档记录的，并确保这里没有引入突破性的更改。确保它符合我们的命名惯例等等。

如果你愿意更进一步，你可以涉足 API 契约测试，如前所述，包括编写和运行测试，以确保微服务的显式和隐式契约正常工作。

#### 2.全套一揽子战略

完整的一揽子堆栈策略需要在本地复制一个云环境，并在一个 vagger 实例中测试所有内容(“$ vagger up”)。问题？这非常棘手，Imgix 的软件工程师 Cindy Sridharan 在一篇博客文章中解释道:

> 在我之前工作的一家公司，我有过这种谬论的第一手经验，我们试图在一个(本地的)流浪盒子里旋转我们的整个堆栈。正如你可能想象的那样，这个想法是，一个简单的迁移应该使公司中的任何工程师(甚至前端和移动开发人员)能够在他们的笔记本电脑上旋转整个堆栈。

Sridharan 继续详细介绍了该公司如何只有两个微服务，一个基于 gevent 的 API 服务器和一些异步 Python 后台工作人员。无论如何，这是一个相对简单的设置。

“我记得在这家公司的第一周，我花了整整一周时间试图在本地成功启动虚拟机，结果却遇到了大量错误。最后，在我第一周的星期五下午 4:00 左右，我成功地让流浪者设置工作起来，并在本地通过了所有测试。我记得自己感到极度疲惫，”她叙述道。

此外，Sumo Logic 的首席架构师 Stefan Zier 向我解释说——除了难以实现之外——这种本地化测试策略根本无法扩展:

“[通过]本地部署，我们在那里运行大部分服务，因此您可以获得一个完全运行的系统，这现在甚至使 16GB RAM 的机器变得非常困难。所以这并不能真正规模化，”他说。

#### 3.AWS 测试策略

第三个策略包括为每个工程师部署和运行测试构建 Amazon Web Services (AWS)基础设施。这是一种更具可扩展性的方法，可以替代上面讨论的全堆栈机箱中策略。

齐尔称之为“个人部署[战略]，这里的每个人都有自己的 AWS 账户。”

“你可以在 10 分钟内将笔记本电脑上的代码上传到 AWS，就像在一个真实的系统中运行一样，”他说。

#### 4.共享测试实例策略

我喜欢把这第四种策略看作是全栈式测试和 AWS 测试的混合体。这是因为它涉及开发人员从他们自己的本地工作站工作，同时利用一个单独的共享微服务实例在测试期间指向他们的本地环境。

Scaylr 工程主管 Steven Czerwinski 解释了这在实践中的工作原理:

> 一些(我们的)开发人员运行一个单独的微服务实例，只是为了测试本地构建。假设你是一名开发人员，你正在本地工作站上开发，你没有启动图像解析器的简单方法。然而，您的本地构建器只会指向运行在 Google 基础设施中的测试图像解析器。

#### 5.失败的服务策略

最后，我们有存根服务测试策略。

Zier 向我展示了 SumoLogic 的存根服务测试方法，“存根让我们编写这些微服务的标记或‘存根’,这些标记或‘存根’表现得好像它们是正确的服务，它们在我们的服务发现中宣传自己，好像它们是真正的服务，但它们只是虚拟的模仿，”他解释道。

例如，测试服务可能需要服务意识到用户执行了一组任务。使用存根服务，您可以假装用户(及其任务)已经发生，而没有随之而来的通常的复杂性。与整体运行服务相比，这种方法要轻量得多。

### 帮助您测试微服务的工具

以下是我在自己的微服务测试经历中受益匪浅的工具列表，这些工具得到了来自 CTO 和高级开发人员的一些建议的支持:

*   [Hoverfly](https://hoverfly.io/) :模拟 API 延迟和故障。
*   [流浪者](https://www.vagrantup.com/):构建和维护可移植的虚拟软件开发环境
*   VCR :一个单元测试工具
*   契约:框架消费者驱动的契约测试。
*   [养蜂场](https://apiary.io/) : API 文档工具
*   [API 蓝图](https://apiblueprint.org/):设计和原型 API
*   设计和原型 API

### 微服务测试:困难，但值得

测试您的微服务不是在公园散步，但是额外的工作值得拥有微服务架构的好处。

此外，SumoLogic 和 Scaylr 等公司采用的微服务测试策略应该有助于平滑这个过程。以下是这些策略的简要回顾:

1.  文档优先策略
2.  全套一揽子战略
3.  AWS 测试策略
4.  共享测试实例策略
5.  失败的服务策略

当然，您可能需要调整每个策略来匹配您独特的环境，但是通过一些好的老式的试错法，您的微服务测试策略应该有它自己的价值。

如果你喜欢这篇文章，请在下面鼓掌帮助它传播！更多类似的内容，请在 [Twitter](https://twitter.com/ButterCMS) 上关注我们，在[订阅](https://buttercms.com/blog/)我们的博客。

杰克·卢梅塔是 [ButterCMS](https://buttercms.com/) 的首席执行官，正在为初创公司发布[微服务。](https://buttercms.com/books/microservices-for-startups/)

如果你想在你的网站上添加博客或内容管理系统，而又不想乱用 Wordpress，[你应该试试黄油内容管理系统](https://buttercms.com/)。